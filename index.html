<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Web Jordan Radios</title>
  
  <meta name="theme-color" content="#F8F9FA">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-1024.png">
  <link rel="apple-touch-icon" href="icon-1024.png">
  	
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    :root {
      /* Light Mode */
      --page-bg-color: #F8F9FA; --card-bg-color: #FFFFFF; --text-color: rgba(0, 0, 0, 0.87);
      --title-color: rgba(0, 0, 0, 0.87); --secondary-text-color: rgba(0, 0, 0, 0.60);
      --icon-color: rgba(0, 0, 0, 0.54); --icon-hover-color: rgba(0, 0, 0, 0.87);
      --icon-hover-bg: rgba(0, 0, 0, 0.08); --card-box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      --station-item-active-bg: #E3F2FD; --station-item-active-text: #1565C0;
      --divider-color: #E9ECEF; --input-bg-color: #F1F5F9; --input-border-color: #CBD5E1;
      --button-primary-bg: #3B82F6; --button-primary-text: #FFFFFF;
      --button-secondary-bg: #E2E8F0; --button-secondary-text: #334155;
      --button-danger-bg: #DC2626;
      --button-danger-text: #FFFFFF;
      --button-danger-confirm-bg: #DC2626; 
      --button-danger-confirm-text: #FFFFFF;
      --page-bg-gradient: radial-gradient(circle, #ffffff 0%, #F8F9FA 100%);
    }
    .dark-mode {
      /* Gray Theme Dark Mode */
      --page-bg-color: #18181B;
      --card-bg-color: #27272A;
      --text-color: rgba(255, 255, 255, 0.90);
      --title-color: #FFFFFF;
      --secondary-text-color: rgba(255, 255, 255, 0.60);
      --icon-color: rgba(255, 255, 255, 0.70);
      --icon-hover-color: #FFFFFF;
      --icon-hover-bg: rgba(255, 255, 255, 0.1);
      --card-box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
      --station-item-active-bg: #3F3F46;
      --station-item-active-text: #FFFFFF;
      --divider-color: #3F3F46;
      --input-bg-color: #3F3F46;
      --input-border-color: #52525B;
      --button-primary-bg: #3B82F6;
      --button-primary-text: #FFFFFF;
      --button-secondary-bg: #3F3F46;
      --button-secondary-text: #E4E4E7;
      --button-danger-bg: #DC2626;
      --button-danger-text: #FFFFFF;
      --button-danger-confirm-bg: #DC2626;
      --button-danger-confirm-text: #FFFFFF;
      --page-bg-gradient: radial-gradient(circle, #27272A 0%, #18181B 100%);
    }

    html, body { height: 100%; margin: 0; }
    body { 
      font-family: 'Inter', sans-serif; 
      background: var(--page-bg-gradient); 
      color: var(--text-color); 
      line-height: 1.5; 
      display: grid; 
      place-content: center; 
      padding: 1rem; 
      box-sizing: border-box;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    .main-content { width: 100%; }
    .container { max-width: 350px; width: 100%; margin: 0 auto; background-color: var(--card-bg-color); border-radius: 12px; box-shadow: var(--card-box-shadow); overflow: hidden; display: flex; flex-direction: column; }
    .header-area { padding: 1.0rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--divider-color); }
    .main-title-group { display: flex; align-items: center; gap: 12px; overflow: hidden; }
    .header-image {
      width: 42px;
      height: 21px;
      border-radius: 4px;
      object-fit: contain;
      flex-shrink: 0;
    }
    .main-title { font-size: var(--main-title-font-size, 1.75rem); font-weight: 700; color: var(--title-color); white-space: nowrap; }
    #settingsBtn { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--icon-color); transition: background-color 0.2s, color 0.2s; }
    #settingsBtn:hover { background-color: var(--icon-hover-bg); color: var(--icon-hover-color); }
    #settingsBtn i { font-size: 1.5rem; }

    .station-list {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      padding: 1rem;
      max-height: 528px;
      /* min-height has been removed to bring back the jump effect */
      overflow-y: auto;
      scrollbar-width: none;
    }
    .station-list::-webkit-scrollbar { display: none; }

    .station-list li {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      direction: ltr;
    }
    .station-list li.active {
      background-color: var(--station-item-active-bg);
    }
    .station-list li.active .station-logo {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease;
    }

    .station-logo {
      width: 64px;
      height: 64px;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      object-fit: cover;
      flex-shrink: 0;
      pointer-events: none;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .station-name-text {
      font-size: var(--station-name-font-size, 0.875rem);
      font-weight: 500;
      text-align: center;
      color: var(--text-color);
      width: 100%;
      word-break: break-word;
      pointer-events: none;
    }
    li.active .station-name-text {
      font-weight: 700;
      color: var(--station-item-active-text);
    }
    
    .edit-btn {
      position: absolute;
      top: 0;
      left: 0;
      background: none;
      border: none;
      color: var(--icon-color);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }
    .edit-btn:hover {
      background-color: var(--icon-hover-bg);
      color: var(--icon-hover-color);
    }
    .edit-btn i {
      font-size: 1.25rem;
    }
    
    .station-list li.show-edit-btn .edit-btn {
        opacity: 1;
        visibility: visible;
    }

    .hidden { display: none !important; }

    .station-list li.sortable-ghost {
      opacity: 0.5;
    }

    #audioPlayerContainer { padding: 0.75rem 1rem; border-top: 1px solid var(--divider-color); }
    .plyr--audio { border-radius: 6px !important; }
    #audioPlayerContainer .plyr__progress, #audioPlayerContainer .plyr__time { display: none; }
    #audioPlayerContainer .plyr__controls { display: flex; justify-content: center !important; align-items: center; gap: 12px; }
    #audioPlayerContainer .plyr__controls button[data-plyr="play"] { order: -2; }
    #audioPlayerContainer .plyr__controls::before { content: 'LIVE'; color: #e11d48; font-size: 10px; font-weight: bold; background-color: rgba(225, 29, 72, 0.1); padding: 4px 8px; border-radius: 4px; order: -1; }
    .dark-mode .plyr--audio { --plyr-audio-controls-background: var(--card-bg-color); --plyr-audio-control-color: var(--icon-color); --plyr-audio-control-color-hover: var(--icon-hover-color); --plyr-audio-control-background-hover: var(--icon-hover-bg); --plyr-color-main: var(--button-primary-bg); }
    .dark-mode #audioPlayerContainer .plyr__controls::before { color: #f43f5e; background-color: rgba(244, 63, 94, 0.2); }

    /* --- START: MODIFIED CSS FOR MODALS --- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      display: grid;
      place-items: center; /* This centers everything by default */
      z-index: 1000;
      overflow-y: auto;
    }

    /* This new class is added ONLY to small modals to adjust their vertical alignment */
    .modal-overlay-small {
      align-items: start;
      padding-top: 25vh;
    }
    /* --- END: MODIFIED CSS FOR MODALS --- */

    .modal-content { position: relative; background-color: var(--card-bg-color); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 1.5rem; max-height: 90vh; overflow-y: auto; }
    .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--title-color); }
    .modal-form { display: flex; flex-direction: column; gap: 1rem; }
    form.modal-form { margin-bottom: -0.3rem; }
    .modal-form label { display: block; font-weight: 500; margin-bottom: 0.5rem; }
    .modal-form input { width: 100%; padding: 0.75rem; border: 1px solid var(--input-border-color); background-color: var(--input-bg-color); color: var(--text-color); border-radius: 6px; box-sizing: border-box; }
    .modal-form .form-note { font-size: 0.8rem; color: var(--secondary-text-color); margin-top: 0.4rem; }
    .modal-form .modal-actions { margin-top: 0.5rem; }
    .modal-actions { display: flex; justify-content: center; gap: 0.75rem; }
    .modal-actions button, .settings-section button { padding: 0.6rem 1.2rem; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; transition: opacity 0.2s; }
    .modal-actions button:hover, .settings-section button:hover { opacity: 0.85; }
    .btn-primary { background-color: var(--button-primary-bg); color: var(--button-primary-text); }
    .btn-secondary { background-color: var(--button-secondary-bg); color: var(--button-secondary-text); }
    .btn-danger { background-color: var(--button-danger-bg); color: var(--button-danger-text); }
    .btn-danger-confirm { background-color: var(--button-danger-confirm-bg); color: var(--button-danger-confirm-text); }
    .modal-close-btn { position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; color: var(--icon-color); cursor: pointer; padding: 0.5rem; border-radius: 50%; }
    .modal-close-btn:hover { background-color: var(--icon-hover-bg); color: var(--icon-hover-color); }
    .modal-close-btn i { font-size: 1.5rem; }
    .settings-section { display: flex; flex-direction: column; gap: 0.75rem; }
    .settings-section-title { font-weight: 700; font-size: 1.1rem; color: var(--title-color); border-bottom: 1px solid var(--divider-color); padding-bottom: 0.5rem; margin-bottom: 0.5rem; }
    .confirm-text {
      font-size: 1.1rem;
      margin: 0.3rem 0 1.3rem;
      text-align: left;
    }
    .export-options { display: flex; justify-content: space-around; padding: 0.5rem 0; }
    .export-options label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }

    /* RTL Styles for Arabic Language */
    body.lang-ar .header-area,
    body.lang-ar .main-title-group { flex-direction: row-reverse; }
    body.lang-ar .modal-content { direction: rtl; }
    body.lang-ar .modal-close-btn { right: auto; left: 0.75rem; }
    body.lang-ar #editStationForm .modal-actions { flex-direction: row-reverse; }
    body.lang-ar .confirm-text { text-align: right; }
    
  </style>
</head>
<body>

  <main class="main-content">
    <div class="container">
      <div class="header-area">
        <div class="main-title-group">
          <img id="headerImage" class="header-image" style="display: none;">
          <h1 id="mainTitle" class="main-title" data-lang-key="pageTitle">Jordan Radios</h1>
        </div>
        <button id="settingsBtn" title="Settings"><i class="ph ph-gear"></i></button>
      </div>
      <ul id="stationList" class="station-list"></ul>
      <div id="audioPlayerContainer"><audio id="audioPlayer" class="plyr-audio"></audio></div>
    </div>
  </main>
  
  <div id="stationModal" class="modal-overlay hidden">
    <div class="modal-content">
      <button id="closeModalBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
      <div style="display: flex; align-items: center; gap: 1rem;"><img id="modalStationImage" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;"><h3 id="modalStationName" class="modal-title"></h3></div>
      <form id="editStationForm" class="modal-form">
        <div><label for="editStationName" data-lang-key="stationNameLabel">Station Name</label><input type="text" id="editStationName" required></div>
        <div><label for="editStreamUrl" data-lang-key="streamUrlLabel">Stream URL</label><input type="text" id="editStreamUrl" required></div>
        <div><label for="editLogoUrl" data-lang-key="logoUrlLabel">Logo URL</label><input type="text" id="editLogoUrl"></div>
        <div><label for="editStreamType" data-lang-key="streamTypeLabel">Stream Type (e.g., MP3 128k)</label><input type="text" id="editStreamType"></div>
        <div class="modal-actions">
            <button type="button" id="deleteStationBtn" class="btn-danger" data-lang-key="deleteBtn">Delete</button>
            <button type="submit" class="btn-primary" data-lang-key="saveBtn">Save</button>
        </div>
      </form>
    </div>
  </div>
  <div id="addStationModal" class="modal-overlay hidden">
      <div class="modal-content">
        <button id="closeAddModalBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
        <h3 class="modal-title" data-lang-key="addStationModalTitle">Add New Station</h3>
        <form id="addStationForm" class="modal-form">
          <div><label for="addStationNameInput" data-lang-key="stationNameLabel">Station Name</label><input type="text" id="addStationNameInput" required></div>
          <div><label for="addStreamUrl" data-lang-key="streamUrlLabel">Stream URL</label><input type="text" id="addStreamUrl" required></div>
          <div><label for="addLogoUrl" data-lang-key="logoUrlLabel">Logo URL</label><input type="text" id="addLogoUrl"></div>
          <div><label for="addStreamType" data-lang-key="streamTypeLabelShort">Stream Type</label><input type="text" id="addStreamType"></div>
          <div class="modal-actions"><button type="submit" class="btn-primary" data-lang-key="addStationBtn">Add Station</button></div>
        </form>
      </div>
  </div>

  <div id="settingsModal" class="modal-overlay hidden">
    <div class="modal-content">
        <button id="closeSettingsBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
        <h3 class="modal-title" data-lang-key="settingsTitle">Settings</h3>
        
        <div class="settings-section">
            <h4 class="settings-section-title" data-lang-key="appearanceTitle">Appearance</h4>
            <button id="themeToggleBtn" class="btn-secondary"></button>
            <button id="langToggleBtn" class="btn-secondary"></button>
            <button id="personalizeBtn" class="btn-secondary" data-lang-key="personalizeBtn">Personalize UI</button>
        </div>

        <div class="settings-section">
            <h4 class="settings-section-title" data-lang-key="manageListTitle">Manage List</h4>
            <button id="addStationBtn" class="btn-secondary" data-lang-key="addStationBtn">Add New Station</button>
            <button id="openImportOptionsBtn" class="btn-secondary" data-lang-key="importBtn">Import...</button>
            <button id="openExportOptionsBtn" class="btn-secondary" data-lang-key="exportBtn">Export...</button>
            <input type="file" id="fileInput" accept=".json,.m3u,.m3u8" class="hidden">
        </div>
        
        <div class="settings-section">
            <button id="resetBtn" class="btn-danger" data-lang-key="resetBtn">Reset to Default</button>
        </div>
    </div>
  </div>

  <div id="personalizationModal" class="modal-overlay hidden">
      <div class="modal-content">
        <button id="closePersonalizationModalBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
        <h3 class="modal-title" data-lang-key="personalizationTitle">Personalization</h3>
        <form id="personalizationForm" class="modal-form">
            <div>
                <label for="customTitleInput" data-lang-key="customTitleLabel">Custom Title</label>
                <input type="text" id="customTitleInput" placeholder="e.g., Quran Radio">
            </div>
            <div>
                <label for="customImageUrlInput" data-lang-key="customImageUrlLabel">Custom Image URL</label>
                <input type="text" id="customImageUrlInput" placeholder="https://example.com/image.png (optional)">
            </div>
            <div>
                <div style="display: flex; gap: 1rem;">
                    <div style="flex: 1;">
                        <label for="customImageWidthInput" data-lang-key="customImageWidthLabel">Image Width (px)</label>
                        <input type="number" id="customImageWidthInput" data-lang-placeholder-key="customImageWidthPlaceholder">
                    </div>
                    <div style="flex: 1;">
                        <label for="customImageHeightInput" data-lang-key="customImageHeightLabel">Image Height (px)</label>
                        <input type="number" id="customImageHeightInput" data-lang-placeholder-key="customImageHeightPlaceholder">
                    </div>
                </div>
                <p class="form-note" data-lang-key="dimensionsNote"></p>
            </div>
            <div>
                <label for="customTitleFontSizeInput" data-lang-key="titleFontSizeLabel">Title Font Size (rem)</label>
                <input type="number" id="customTitleFontSizeInput" placeholder="Default: 1.75" step="0.05">
            </div>
            <div>
                <label for="customStationFontSizeInput" data-lang-key="stationFontSizeLabel">Station Font Size (rem)</label>
                <input type="number" id="customStationFontSizeInput" placeholder="Default: 0.875" step="0.05">
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn-primary" data-lang-key="saveBtn">Save</button>
            </div>
        </form>
      </div>
  </div>

  <!-- START: MODIFIED SMALL MODALS -->
  <div id="importOptionsModal" class="modal-overlay modal-overlay-small hidden">
      <div class="modal-content">
        <button id="closeImportOptionsBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
        <h3 class="modal-title" data-lang-key="importOptionsTitle">Choose Import Type</h3>
        <div class="modal-actions" style="flex-direction: column;">
            <button id="importStationsChoiceBtn" class="btn-secondary" data-lang-key="stationsListOnly">Stations List Only</button>
            <button id="importProfileChoiceBtn" class="btn-secondary" data-lang-key="fullProfileBackup">Full Profile (Stations & UI)</button>
        </div>
      </div>
  </div>
  
  <div id="exportOptionsModal" class="modal-overlay modal-overlay-small hidden">
    <div class="modal-content">
        <button id="closeExportOptionsBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
        <h3 class="modal-title" data-lang-key="exportOptionsTitle">Choose Export Type</h3>
        
        <div id="exportContentTypeSelection">
            <div class="modal-actions" style="flex-direction: column;">
                <button id="exportStationsChoiceBtn" class="btn-secondary" data-lang-key="stationsListOnly">Stations List Only</button>
                <button id="exportProfileChoiceBtn" class="btn-secondary" data-lang-key="fullProfileBackup">Stations & UI</button>
            </div>
        </div>

        <div id="exportFormatSelection" class="hidden">
            <p class="confirm-text" data-lang-key="exportFormatQuestion">Choose the appropriate file type</p>
            <div class="modal-actions" style="flex-direction: column; gap: 0.75rem;">
                <button id="exportToJsonBtn" class="btn-secondary">JSON</button>
                <button id="exportToM3uBtn" class="btn-secondary">M3U</button>
                <button id="exportToM3u8Btn" class="btn-secondary">M3U8</button>
            </div>
        </div>
    </div>
  </div>

  <div id="importConfirmModal" class="modal-overlay modal-overlay-small hidden">
      <div class="modal-content">
          <button id="closeImportConfirmBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
          <h3 class="modal-title" data-lang-key="importModalTitle">Import List</h3>
          <p class="confirm-text" data-lang-key="importConfirmText">New list ready. Merge with current list or replace it?</p>
          <div class="modal-actions">
              <button id="mergeBtn" class="btn-secondary" data-lang-key="mergeBtn">Merge</button>
              <button id="replaceBtn" class="btn-primary" data-lang-key="replaceBtn">Replace</button>
          </div>
      </div>
  </div>
  <div id="deleteConfirmModal" class="modal-overlay modal-overlay-small hidden">
      <div class="modal-content">
          <button id="cancelDeleteBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
          <h3 class="modal-title" data-lang-key="deleteModalTitle">Confirm Deletion</h3>
          <p id="deleteConfirmText" class="confirm-text"></p>
          <div class="modal-actions">
              <button id="confirmDeleteBtn" class="btn-danger-confirm" data-lang-key="confirmBtn">Confirm</button>
          </div>
      </div>
  </div>
  <div id="resetConfirmModal" class="modal-overlay modal-overlay-small hidden">
      <div class="modal-content">
          <button id="cancelResetBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
          <h3 class="modal-title" data-lang-key="resetModalTitle">Confirm Reset</h3>
          <p class="confirm-text" data-lang-key="resetConfirmText">Are you sure? This will delete all your custom changes and restore the original list.</p>
          <div class="modal-actions">
              <button id="confirmResetBtn" class="btn-danger-confirm" data-lang-key="confirmBtn">Confirm</button>
          </div>
      </div>
  </div>
  <!-- END: MODIFIED SMALL MODALS -->

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <script>
    let stations = [];
    
    const getEl = id => document.getElementById(id);
    const mainTitle = getEl("mainTitle"), headerImage = getEl("headerImage");
    const personalizationModal = getEl("personalizationModal"), personalizeBtn = getEl("personalizeBtn"), closePersonalizationModalBtn = getEl("closePersonalizationModalBtn"), personalizationForm = getEl("personalizationForm");
    const customTitleInput = getEl("customTitleInput"), customImageUrlInput = getEl("customImageUrlInput"), customImageWidthInput = getEl("customImageWidthInput"), customImageHeightInput = getEl("customImageHeightInput"), customTitleFontSizeInput = getEl("customTitleFontSizeInput"), customStationFontSizeInput = getEl("customStationFontSizeInput");
    const body = document.body, stationListUL = getEl("stationList"), audioPlayerContainer = getEl("audioPlayerContainer"),
        audio = getEl("audioPlayer"), stationModal = getEl('stationModal'), closeModalBtn = getEl('closeModalBtn'),
        editStationForm = getEl('editStationForm'), modalStationImage = getEl('modalStationImage'),
        modalStationName = getEl('modalStationName'), editStationName = getEl('editStationName'),
        editStreamUrl = getEl('editStreamUrl'), editLogoUrl = getEl('editLogoUrl'), editStreamType = getEl('editStreamType'), 
        deleteStationBtn = getEl('deleteStationBtn'), settingsBtn = getEl('settingsBtn'), settingsModal = getEl('settingsModal'),
        closeSettingsBtn = getEl('closeSettingsBtn'), themeToggleBtn = getEl('themeToggleBtn'), langToggleBtn = getEl('langToggleBtn'),
        addStationBtn = getEl('addStationBtn'), 
        openImportOptionsBtn = getEl('openImportOptionsBtn'), openExportOptionsBtn = getEl('openExportOptionsBtn'),
        fileInput = getEl('fileInput'), 
        resetBtn = getEl('resetBtn'), addStationModal = getEl('addStationModal'), closeAddModalBtn = getEl('closeAddModalBtn'),
        addStationForm = getEl('addStationForm'), addStationNameInput = getEl('addStationNameInput'),
        addStreamUrl = getEl('addStreamUrl'), addLogoUrl = getEl('addLogoUrl'), addStreamType = getEl('addStreamType'),
        importConfirmModal = getEl('importConfirmModal'), closeImportConfirmBtn = getEl('closeImportConfirmBtn'),
        mergeBtn = getEl('mergeBtn'), replaceBtn = getEl('replaceBtn'),
        deleteConfirmModal = getEl('deleteConfirmModal'), cancelDeleteBtn = getEl('cancelDeleteBtn'),
        confirmDeleteBtn = getEl('confirmDeleteBtn'), deleteConfirmText = getEl('deleteConfirmText'),
        resetConfirmModal = getEl('resetConfirmModal'), cancelResetBtn = getEl('cancelResetBtn'),
        confirmResetBtn = getEl('confirmResetBtn'),
        importOptionsModal = getEl('importOptionsModal'), closeImportOptionsBtn = getEl('closeImportOptionsBtn'), importStationsChoiceBtn = getEl('importStationsChoiceBtn'), importProfileChoiceBtn = getEl('importProfileChoiceBtn'),
        exportOptionsModal = getEl('exportOptionsModal'), closeExportOptionsBtn = getEl('closeExportOptionsBtn'), exportStationsChoiceBtn = getEl('exportStationsChoiceBtn'), exportProfileChoiceBtn = getEl('exportProfileChoiceBtn'),
        exportContentTypeSelection = getEl('exportContentTypeSelection'), exportFormatSelection = getEl('exportFormatSelection'),
        exportToJsonBtn = getEl('exportToJsonBtn'), exportToM3uBtn = getEl('exportToM3uBtn'), exportToM3u8Btn = getEl('exportToM3u8Btn');

    const player = new Plyr(audio, {});
    let currentEditingIndex = null, importedStations = [];
    let hls = null; 
    let currentLang = 'en';
    let editButtonHideTimer = null;
    
    const translations = {
        pageTitle: { en: 'Jordan Radios', ar: 'إذاعات الأردن' },
        personalizeBtn: { en: 'Personalize UI', ar: 'تخصيص الواجهة' },
        personalizationTitle: { en: 'Personalization', ar: 'تخصيص الواجهة' },
        customTitleLabel: { en: 'Custom Title', ar: 'عنوان مخصص' },
        customImageUrlLabel: { en: 'Custom Image URL', ar: 'رابط صورة مخصصة' },
        customImageWidthLabel: { en: 'Image Width (px)', ar: 'عرض الصورة (بكسل)' },
        customImageHeightLabel: { en: 'Image Height (px)', ar: 'ارتفاع الصورة (بكسل)' },
        customImageWidthPlaceholder: { en: 'Default: auto', ar: 'الافتراضي: تلقائي' },
        customImageHeightPlaceholder: { en: 'Default: 21', ar: 'الافتراضي: 21' },
        dimensionsNote: { en: 'Tip: If only height is set, width adjusts automatically.', ar: 'نصيحة: إذا تم ضبط الارتفاع فقط، يتم ضبط العرض تلقائيًا.' },
        titleFontSizeLabel: { en: 'Title Font Size (rem)', ar: 'حجم خط العنوان (rem)' },
        stationFontSizeLabel: { en: 'Station Font Size (rem)', ar: 'حجم خط الإذاعة (rem)' },
        importOptionsTitle: { en: 'Choose Import Type', ar: 'اختر نوع الاستيراد' },
        exportOptionsTitle: { en: 'Choose Export Type', ar: 'اختر نوع التصدير' },
        stationsListOnly: { en: 'Stations List Only', ar: 'قائمة المحطات فقط' },
        fullProfileBackup: { en: 'Stations & UI', ar: 'المحطات والواجهة' },
        exportFormatQuestion: { en: 'Choose the appropriate file type', ar: 'اختر نوع الملف المناسب' },
        settingsTitle: { en: 'Settings', ar: 'الإعدادات' },
        appearanceTitle: { en: 'Appearance', ar: 'المظهر' },
        manageListTitle: { en: 'Manage List', ar: 'إدارة القائمة' },
        addStationBtn: { en: 'Add New Station', ar: 'إضافة محطة جديدة' },
        importBtn: { en: 'Import', ar: 'استيراد' },
        exportBtn: { en: 'Export', ar: 'تصدير' },
        resetBtn: { en: 'Reset to Default', ar: 'إعادة للوضع الافتراضي' },
        themeToggleLight: { en: 'Switch to Light Mode', ar: 'التحويل للوضع النهاري' },
        themeToggleDark: { en: 'Switch to Dark Mode', ar: 'التحويل للوضع الليلي' },
        langToggle: { en: 'Switch to Arabic', ar: 'التحويل إلى الإنجليزية' },
        streamUrlLabel: { en: 'Stream URL', ar: 'رابط البث' },
        logoUrlLabel: { en: 'Logo URL', ar: 'رابط الشعار' },
        streamTypeLabel: { en: 'Stream Type (e.g., MP3 128k)', ar: 'نوع البث (مثال: MP3 128k)' },
        streamTypeLabelShort: { en: 'Stream Type', ar: 'نوع البث' },
        deleteBtn: { en: 'Delete', ar: 'حذف' },
        saveBtn: { en: 'Save', ar: 'حفظ' },
        addStationModalTitle: { en: 'Add New Station', ar: 'إضافة محطة جديدة' },
        stationNameLabel: { en: 'Station Name', ar: 'اسم المحطة' },
        importModalTitle: { en: 'Import List', ar: 'استيراد قائمة' },
        importConfirmText: { en: 'New list ready. Merge with current list or replace it?', ar: 'القائمة الجديدة جاهزة. هل تريد دمجها مع الحالية أم استبدالها؟' },
        mergeBtn: { en: 'Merge', ar: 'دمج' },
        replaceBtn: { en: 'Replace', ar: 'استبدال' },
        deleteModalTitle: { en: 'Confirm Deletion', ar: 'تأكيد الحذف' },
        confirmBtn: { en: 'Confirm', ar: 'تأكيد' },
        resetModalTitle: { en: 'Confirm Reset', ar: 'تأكيد إعادة التعيين' },
        resetConfirmText: { en: 'Are you sure? This will delete all your custom changes and restore the original list.', ar: 'هل أنت متأكد؟ سيتم حذف كل التغييرات المخصصة واستعادة القائمة الأصلية.' },
        alertRequired: { en: 'Station Name and Stream URL are required.', ar: 'اسم المحطة ورابط البث مطلوبان.' },
        alertUnsupported: { en: 'Unsupported file type.', ar: 'نوع الملف غير مدعوم.' },
        alertInvalid: { en: 'File is empty or invalid.', ar: 'الملف فارغ أو غير صالح.' },
        alertParseFail: { en: 'Failed to parse the file.', ar: 'فشل في تحليل الملف.' },
        deleteConfirmText: { en: 'Are you sure you want to delete "{stationName}"?', ar: 'هل أنت متأكد من حذف "{stationName}"؟' }
    };
    
    const applyFontSizes = () => { const titleSize = localStorage.getItem('customTitleFontSize'); const stationSize = localStorage.getItem('customStationFontSize'); if (titleSize) { document.documentElement.style.setProperty('--main-title-font-size', titleSize + 'rem'); } else { document.documentElement.style.removeProperty('--main-title-font-size'); } if (stationSize) { document.documentElement.style.setProperty('--station-name-font-size', stationSize + 'rem'); } else { document.documentElement.style.removeProperty('--station-name-font-size'); } };
    const applyCustomization = (title, imageUrl, width, height) => { if (title) { mainTitle.textContent = title; document.title = title; mainTitle.removeAttribute('data-lang-key'); } else { mainTitle.setAttribute('data-lang-key', 'pageTitle'); mainTitle.textContent = translations.pageTitle[currentLang]; document.title = "Web Jordan Radios"; } if (imageUrl) { headerImage.src = imageUrl; headerImage.style.display = 'block'; headerImage.style.height = height ? `${height}px` : '21px'; headerImage.style.width = width ? `${width}px` : 'auto'; headerImage.style.maxWidth = 'none'; headerImage.style.objectFit = 'contain'; } else { headerImage.style.display = 'none'; } };
    const saveCustomization = (e) => { e.preventDefault(); const newTitle = customTitleInput.value.trim(); const newImageUrl = customImageUrlInput.value.trim(); const newWidth = customImageWidthInput.value.trim(); const newHeight = customImageHeightInput.value.trim(); const newTitleSize = customTitleFontSizeInput.value.trim(); const newStationSize = customStationFontSizeInput.value.trim(); localStorage.setItem('customTitle', newTitle); localStorage.setItem('customImageUrl', newImageUrl); localStorage.setItem('customImageWidth', newWidth); localStorage.setItem('customImageHeight', newHeight); localStorage.setItem('customTitleFontSize', newTitleSize); localStorage.setItem('customStationFontSize', newStationSize); applyCustomization(newTitle, newImageUrl, newWidth, newHeight); applyFontSizes(); personalizationModal.classList.add('hidden'); };
    const openPersonalizationModal = () => { customTitleInput.value = localStorage.getItem('customTitle') || ''; customImageUrlInput.value = localStorage.getItem('customImageUrl') || ''; customImageWidthInput.value = localStorage.getItem('customImageWidth') || ''; customImageHeightInput.value = localStorage.getItem('customImageHeight') || ''; customTitleFontSizeInput.value = localStorage.getItem('customTitleFontSize') || ''; customStationFontSizeInput.value = localStorage.getItem('customStationFontSize') || ''; settingsModal.classList.add('hidden'); personalizationModal.classList.remove('hidden'); };
    const getStationName = (station) => { if (typeof station.name === 'object' && station.name !== null) { return station.name[currentLang] || station.name['en']; } return station.name; };
    const setLanguage = (lang) => { currentLang = lang; localStorage.setItem('language', lang); document.documentElement.lang = lang; body.classList.toggle('lang-ar', lang === 'ar'); document.querySelectorAll('[data-lang-key]').forEach(el => { const key = el.getAttribute('data-lang-key'); if (translations[key] && translations[key][lang]) { el.textContent = translations[key][lang]; } }); document.querySelectorAll('[data-lang-placeholder-key]').forEach(el => { const key = el.getAttribute('data-lang-placeholder-key'); if (translations[key] && translations[key][lang]) { el.placeholder = translations[key][lang]; } }); const savedTitle = localStorage.getItem('customTitle'); if (!savedTitle) { mainTitle.textContent = translations.pageTitle[lang]; } renderStationList(); updateThemeButtonText(); updateLangButtonText(); };
    const renderStationList = () => { const currentlyPlayingUrl = stationListUL.querySelector('li.active')?.dataset.url; stationListUL.innerHTML = ''; stations.forEach((station, index) => { const li = document.createElement("li"); li.dataset.index = index; if (station.url === currentlyPlayingUrl) { li.classList.add('active'); } li.dataset.url = station.url; const stationName = getStationName(station); li.innerHTML = `<img src="${station.logoUrl || 'icon-1024.png'}" class="station-logo" onerror="this.onerror=null;this.src='icon-1024.png';"><span class="station-name-text">${stationName}</span><button class="edit-btn"><i class="ph ph-dots-three-vertical"></i></button>`; li.addEventListener("click", () => playStation(li, station)); const editBtn = li.querySelector('.edit-btn'); editBtn.addEventListener('click', (e) => { e.stopPropagation(); openEditModal(station, index); }); stationListUL.appendChild(li); }); };
    
    const playStation = (li, station) => {
      const wasActive = li.classList.contains('active');
      if (!wasActive) {
          const oldActiveItem = stationListUL.querySelector("li.active");
          if (oldActiveItem) {
              oldActiveItem.classList.remove("active", "show-edit-btn");
          }
          li.classList.add("active");
          if (hls) {
              hls.destroy();
              hls = null;
          }
          const isM3U8 = station.url.includes('.m3u8');
          const isProxied = station.url.includes('proxy.iofahmawi.workers.dev');
          if (isM3U8 && isProxied && Hls.isSupported()) {
              player.source = { type: 'audio', title: getStationName(station), sources: [{ src: 'blank.mp3', type: 'audio/mpeg' }] };
              player.stop();
              const proxyUrlBase = station.url.split('?url=')[0] + '?url=';
              hls = new Hls({
                  xhrSetup: function(xhr, url) {
                      const originalUrl = url;
                      if (!url.startsWith(proxyUrlBase) && url.includes('http')) {
                          xhr.open('GET', proxyUrlBase + encodeURIComponent(originalUrl));
                      } else {
                          xhr.open('GET', originalUrl);
                      }
                  }
              });
              hls.attachMedia(audio);
              hls.on(Hls.Events.MEDIA_ATTACHED, () => hls.loadSource(station.url));
              hls.on(Hls.Events.MANIFEST_PARSED, () => player.play().catch(e => console.warn(`Error playing:`, e)));
          } else {
              player.source = { type: 'audio', title: getStationName(station), sources: [{ src: station.url, type: isM3U8 ? 'application/x-mpegURL' : 'audio/mpeg' }] };
              player.play().catch(e => console.warn(`Error playing:`, e));
          }
      } else {
          player.togglePlay();
      }
      resetEditButtonTimer();
    };

    const saveStations = () => localStorage.setItem('savedStations', JSON.stringify(stations));
    const saveAndRerender = () => { saveStations(); renderStationList(); };
    const openEditModal = (station, index) => { const stationName = getStationName(station); currentEditingIndex = index; modalStationImage.src = station.logoUrl; modalStationName.textContent = stationName; editStationName.value = stationName; editStreamUrl.value = station.url; editLogoUrl.value = station.logoUrl; editStreamType.value = station.streamType || ''; stationModal.classList.remove('hidden'); };
    const openDeleteConfirm = (station, index) => { currentEditingIndex = index; const stationName = getStationName(station); deleteConfirmText.textContent = translations.deleteConfirmText[currentLang].replace('{stationName}', stationName); deleteConfirmModal.classList.remove('hidden'); };
    const closeEditModal = () => stationModal.classList.add('hidden');
    const saveStationChanges = e => { e.preventDefault(); if (currentEditingIndex === null) return; const station = stations[currentEditingIndex]; const newName = editStationName.value.trim(); const newUrl = editStreamUrl.value.trim(); if (!newName || !newUrl) { return alert(translations.alertRequired[currentLang]); } if (typeof station.name === 'object' && station.name !== null) { station.name[currentLang] = newName; } else { station.name = newName; } station.url = newUrl; station.logoUrl = editLogoUrl.value.trim(); station.streamType = editStreamType.value.trim(); saveAndRerender(); closeEditModal(); };
    const closeDeleteConfirm = () => deleteConfirmModal.classList.add('hidden');
    const deleteStation = () => { if (currentEditingIndex === null) return; stations.splice(currentEditingIndex, 1); saveAndRerender(); closeEditModal(); closeDeleteConfirm(); };
    const openAddModal = () => { addStationForm.reset(); addStationModal.classList.remove('hidden'); };
    const closeAddModal = () => addStationModal.classList.add('hidden');
    const saveNewStation = e => { e.preventDefault(); const name = addStationNameInput.value.trim(), url = addStreamUrl.value.trim(); if (!name || !url) return alert(translations.alertRequired[currentLang]); stations.push({ name: { en: name, ar: name }, url, logoUrl: addLogoUrl.value.trim(), streamType: addStreamType.value.trim() }); saveAndRerender(); closeAddModal(); };
    const openSettingsModal = () => settingsModal.classList.remove('hidden');
    const closeSettingsModal = () => settingsModal.classList.add('hidden');
    const openResetConfirm = () => { closeSettingsModal(); resetConfirmModal.classList.remove('hidden'); };
    const closeResetConfirm = () => resetConfirmModal.classList.add('hidden');
    const resetList = () => { localStorage.removeItem('savedStations'); localStorage.removeItem('customTitle'); localStorage.removeItem('customImageUrl'); localStorage.removeItem('customImageWidth'); localStorage.removeItem('customImageHeight'); localStorage.removeItem('customTitleFontSize'); localStorage.removeItem('customStationFontSize'); location.reload(); };
    const updateThemeButtonText = () => { const key = body.classList.contains('dark-mode') ? 'themeToggleLight' : 'themeToggleDark'; themeToggleBtn.textContent = translations[key][currentLang]; };
    const updateLangButtonText = () => { langToggleBtn.textContent = currentLang === 'en' ? translations.langToggle.en : translations.langToggle.ar; };
    const enableDarkMode = () => { body.classList.add('dark-mode'); localStorage.setItem('theme', 'dark'); updateThemeButtonText(); };
    const disableDarkMode = () => { body.classList.remove('dark-mode'); localStorage.setItem('theme', 'light'); updateThemeButtonText(); };
    const toggleThemeAndClose = () => { (body.classList.contains('dark-mode') ? disableDarkMode() : enableDarkMode()); closeSettingsModal(); };
    const toggleLanguageAndClose = () => { const newLang = currentLang === 'en' ? 'ar' : 'en'; setLanguage(newLang); closeSettingsModal(); };
    const handleFileImport = (e) => { const file = e.target.files[0]; if (!file) return; const importType = e.target.dataset.importType; closeSettingsModal(); const reader = new FileReader(); reader.onload = (ev) => { const content = ev.target.result; try { if (file.name.endsWith('.json')) { const data = JSON.parse(content); if (importType === 'profile' && data.profile && Array.isArray(data.stations)) { localStorage.setItem('savedStations', JSON.stringify(data.stations)); const { title, imageUrl, imageWidth, imageHeight, titleFontSize, stationFontSize, theme, language } = data.profile; const setItemIfDefined = (key, value) => { if (value !== undefined && value !== null) { localStorage.setItem(key, value); } else { localStorage.removeItem(key); } }; setItemIfDefined('customTitle', title); setItemIfDefined('customImageUrl', imageUrl); setItemIfDefined('customImageWidth', imageWidth); setItemIfDefined('customImageHeight', imageHeight); setItemIfDefined('customTitleFontSize', titleFontSize); setItemIfDefined('customStationFontSize', stationFontSize); setItemIfDefined('theme', theme); setItemIfDefined('language', language); location.reload(); return; } const rawStations = Array.isArray(data) ? data : [data]; const findValue = (obj, possibleKeys, defaultValue = '') => { for (const key of possibleKeys) { if (obj[key] && typeof obj[key] === 'string') return obj[key].trim(); } return defaultValue; }; importedStations = rawStations.map(station => { let name; if (typeof station.name === 'object' && station.name !== null) { name = station.name; } else { const nameStr = findValue(station, ['name', 'title', 'station_name', 'stationName'], 'Unknown'); name = { en: nameStr, ar: nameStr }; } const url = findValue(station, ['url', 'stream_url', 'streamUrl', 'stream']); const logoUrl = findValue(station, ['logoUrl', 'logo', 'image', 'thumbnail', 'favicon', 'thumb']); if (!url) return null; return { name: name, url: url, logoUrl: logoUrl, streamType: findValue(station, ['streamType', 'type', 'description'], '') }; }).filter(Boolean); } else if (file.name.match(/\.m3u8?$/)) { importedStations = parseM3U(content); } else { return alert(translations.alertUnsupported[currentLang]); } if (!Array.isArray(importedStations) || !importedStations.length) { return alert(translations.alertInvalid[currentLang]); } importConfirmModal.classList.remove('hidden'); } catch (err) { alert(translations.alertParseFail[currentLang]); console.error("Import Error:", err); } }; reader.readAsText(file); fileInput.value = ''; };
    const parseM3U = (c) => { const lines = c.split('\n'), p = []; for (let i = 0; i < lines.length; i++) { if (lines[i].startsWith('#EXTINF')) { const info = lines[i], url = lines[++i]?.trim(); if (!url) continue; const name = (info.match(/tvg-name="([^"]+)"/) || info.match(/,(.+)$/))?.[1].trim() || 'Unknown', logo = (info.match(/tvg-logo="([^"]+)"/))?.[1].trim() || ''; p.push({ name: { en: name, ar: name }, logoUrl: logo, url, streamType: '' }); } } return p; };
    const mergeLists = () => { const urls = new Set(stations.map(s => s.url)); stations.push(...importedStations.filter(s => !urls.has(s.url))); saveAndRerender(); closeImportConfirmModal(); };
    const replaceList = () => { stations = importedStations; saveAndRerender(); closeImportConfirmModal(); };
    const closeImportConfirmModal = () => importConfirmModal.classList.add('hidden');
    const handleExportStationsAsJson = () => { const filename = `stations_list.json`; const content = JSON.stringify(stations, null, 2); downloadFile(content, filename, 'application/json'); closeExportOptionsModal(); };
    const handleExportProfile = () => { const profileData = { profile: { title: localStorage.getItem('customTitle') || '', imageUrl: localStorage.getItem('customImageUrl') || '', imageWidth: localStorage.getItem('customImageWidth') || '', imageHeight: localStorage.getItem('customImageHeight') || '', titleFontSize: localStorage.getItem('customTitleFontSize') || '', stationFontSize: localStorage.getItem('customStationFontSize') || '', theme: localStorage.getItem('theme') || 'light', language: localStorage.getItem('language') || 'en' }, stations: stations }; const content = JSON.stringify(profileData, null, 2); downloadFile(content, 'radio_profile.json', 'application/json'); closeExportOptionsModal(); };
    const exportToPlaylist = (format) => { let content = '#EXTM3U\n'; stations.forEach(station => { const stationName = getStationName(station).replace(/"/g, "'"); content += `#EXTINF:-1 tvg-name="${stationName}" tvg-logo="${station.logoUrl || ''}",${stationName}\n`; content += `${station.url}\n`; }); const filename = `stations_list.${format}`; downloadFile(content, filename, 'audio/x-mpegurl'); closeExportOptionsModal(); };
    const downloadFile = (content, fileName, contentType) => { const a = document.createElement("a"), file = new Blob([content], { type: contentType }); a.href = URL.createObjectURL(file); a.download = fileName; a.click(); URL.revokeObjectURL(a.href); };
    function resetEditButtonTimer() { clearTimeout(editButtonHideTimer); const activeItem = stationListUL.querySelector('li.active'); if (activeItem) { activeItem.classList.add('show-edit-btn'); editButtonHideTimer = setTimeout(() => { activeItem.classList.remove('show-edit-btn'); }, 5000); } }
    const openImportOptionsModal = () => { settingsModal.classList.add('hidden'); importOptionsModal.classList.remove('hidden'); };
    const closeImportOptionsModal = () => importOptionsModal.classList.add('hidden');
    const openExportOptionsModal = () => { settingsModal.classList.add('hidden'); exportContentTypeSelection.classList.remove('hidden'); exportFormatSelection.classList.add('hidden'); exportOptionsModal.classList.remove('hidden'); };
    const closeExportOptionsModal = () => exportOptionsModal.classList.add('hidden');

    const initialize = async () => {
        const savedStationsJSON = localStorage.getItem('savedStations');

        if (savedStationsJSON) {
            stations = JSON.parse(savedStationsJSON);
        } else {
            try {
                const response = await fetch('https://iofahmawi.github.io/jo-radios/stations_list.json');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const defaultStations = await response.json();
                stations = defaultStations;
                saveStations();
            } catch (error) {
                console.error("Failed to fetch default stations:", error);
                stations = []; 
            }
        }

        const savedTitle = localStorage.getItem('customTitle');
        const savedImageUrl = localStorage.getItem('customImageUrl');
        const savedImageWidth = localStorage.getItem('customImageWidth');
        const savedImageHeight = localStorage.getItem('customImageHeight');
        if (localStorage.getItem('customTitle') !== null || localStorage.getItem('customImageUrl') !== null) {
            applyCustomization(savedTitle, savedImageUrl, savedImageWidth, savedImageHeight);
        } else {
            headerImage.src = "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c0/Flag_of_Jordan.svg/60px-Flag_of_Jordan.svg.png";
            headerImage.style.display = 'block';
            headerImage.style.height = '21px';
            headerImage.style.width = '42px';
        }
        if (localStorage.getItem('theme') === 'dark') enableDarkMode(); else disableDarkMode();
        
        personalizeBtn.addEventListener('click', openPersonalizationModal);
        closePersonalizationModalBtn.addEventListener('click', () => personalizationModal.classList.add('hidden'));
        personalizationModal.addEventListener('click', e => e.target === personalizationModal && personalizationModal.classList.add('hidden'));
        personalizationForm.addEventListener('submit', saveCustomization);
        closeModalBtn.addEventListener('click', closeEditModal);
        closeAddModalBtn.addEventListener('click', closeAddModal);
        closeSettingsBtn.addEventListener('click', closeSettingsModal);
        closeImportConfirmBtn.addEventListener('click', closeImportConfirmModal);
        cancelDeleteBtn.addEventListener('click', closeDeleteConfirm);
        cancelResetBtn.addEventListener('click', closeResetConfirm);
        stationModal.addEventListener('click', e => e.target === stationModal && closeEditModal());
        addStationModal.addEventListener('click', e => e.target === addStationModal && closeAddModal());
        settingsModal.addEventListener('click', e => e.target === settingsModal && closeSettingsModal());
        importConfirmModal.addEventListener('click', e => e.target === importConfirmModal && closeImportConfirmModal());
        deleteConfirmModal.addEventListener('click', e => e.target === deleteConfirmModal && closeDeleteConfirm());
        resetConfirmModal.addEventListener('click', e => e.target === resetConfirmModal && closeResetConfirm());
        editStationForm.addEventListener('submit', saveStationChanges);
        deleteStationBtn.addEventListener('click', () => openDeleteConfirm(stations[currentEditingIndex], currentEditingIndex));
        settingsBtn.addEventListener('click', openSettingsModal);
        themeToggleBtn.addEventListener('click', toggleThemeAndClose);
        langToggleBtn.addEventListener('click', toggleLanguageAndClose);
        addStationBtn.addEventListener('click', () => { closeSettingsModal(); openAddModal(); });
        addStationForm.addEventListener('submit', saveNewStation);
        openImportOptionsBtn.addEventListener('click', openImportOptionsModal);
        openExportOptionsBtn.addEventListener('click', openExportOptionsModal);
        closeImportOptionsBtn.addEventListener('click', closeImportOptionsModal);
        closeExportOptionsBtn.addEventListener('click', closeExportOptionsModal);
        importStationsChoiceBtn.addEventListener('click', () => { fileInput.dataset.importType = 'stations'; fileInput.click(); closeImportOptionsModal(); });
        importProfileChoiceBtn.addEventListener('click', () => { fileInput.dataset.importType = 'profile'; fileInput.click(); closeImportOptionsModal(); });
        exportStationsChoiceBtn.addEventListener('click', () => { exportContentTypeSelection.classList.add('hidden'); exportFormatSelection.classList.remove('hidden'); });
        exportProfileChoiceBtn.addEventListener('click', handleExportProfile);
        exportToJsonBtn.addEventListener('click', handleExportStationsAsJson);
        exportToM3uBtn.addEventListener('click', () => exportToPlaylist('m3u'));
        exportToM3u8Btn.addEventListener('click', () => exportToPlaylist('m3u8'));
        fileInput.addEventListener('change', handleFileImport);
        resetBtn.addEventListener('click', openResetConfirm);
        mergeBtn.addEventListener('click', mergeLists); 
        replaceBtn.addEventListener('click', replaceList);
        confirmDeleteBtn.addEventListener('click', deleteStation);
        confirmResetBtn.addEventListener('click', resetList);
        new Sortable(stationListUL, { animation: 150, ghostClass: 'sortable-ghost', delay: 250, delayOnTouchOnly: true, filter: '.edit-btn', onEnd: function (evt) { const movedItem = stations.splice(evt.oldIndex, 1)[0]; stations.splice(evt.newIndex, 0, movedItem); saveStations(); }, });
        document.addEventListener('mousemove', resetEditButtonTimer);
        document.addEventListener('touchstart', resetEditButtonTimer);
        const savedLang = localStorage.getItem('language') || 'en';
        setLanguage(savedLang);
        applyFontSizes();
    };

    initialize();
  </script>

  <script>
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').then(registration => { console.log('SW registration successful:', registration.scope); }).catch(err => { console.log('SW registration failed:', err); }); }); }
  </script>
</body>
</html>