<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Web Jordan Radios</title>
  
  <meta name="theme-color" content="#F8F9FA">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-1024.png">
  <link rel="apple-touch-icon" href="icon-1024.png">
  	
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    :root {
      /* Light Mode */
      --page-bg-color: #F8F9FA; --card-bg-color: #FFFFFF; --text-color: rgba(0, 0, 0, 0.87);
      --title-color: rgba(0, 0, 0, 0.87); --secondary-text-color: rgba(0, 0, 0, 0.60);
      --icon-color: rgba(0, 0, 0, 0.54); --icon-hover-color: rgba(0, 0, 0, 0.87);
      --icon-hover-bg: rgba(0, 0, 0, 0.08); --card-box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      --station-item-active-bg: #E3F2FD; --station-item-active-text: #1565C0;
      --divider-color: #E9ECEF; --input-bg-color: #F1F5F9; --input-border-color: #CBD5E1;
      --button-primary-bg: #3B82F6; --button-primary-text: #FFFFFF;
      --button-secondary-bg: #E2E8F0; --button-secondary-text: #334155;
      --button-danger-bg: #DC2626;
      --button-danger-text: #FFFFFF;
      --button-danger-confirm-bg: #DC2626; 
      --button-danger-confirm-text: #FFFFFF;
      --page-bg-gradient: radial-gradient(circle, #ffffff 0%, #F8F9FA 100%);
    }
    .dark-mode {
      /* Gray Theme Dark Mode */
      --page-bg-color: #18181B;
      --card-bg-color: #27272A;
      --text-color: rgba(255, 255, 255, 0.90);
      --title-color: #FFFFFF;
      --secondary-text-color: rgba(255, 255, 255, 0.60);
      --icon-color: rgba(255, 255, 255, 0.70);
      --icon-hover-color: #FFFFFF;
      --icon-hover-bg: rgba(255, 255, 255, 0.1);
      --card-box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
      --station-item-active-bg: #3F3F46;
      --station-item-active-text: #FFFFFF;
      --divider-color: #3F3F46;
      --input-bg-color: #3F3F46;
      --input-border-color: #52525B;
      --button-primary-bg: #3B82F6;
      --button-primary-text: #FFFFFF;
      --button-secondary-bg: #3F3F46;
      --button-secondary-text: #E4E4E7;
      --button-danger-bg: #DC2626;
      --button-danger-text: #FFFFFF;
      --button-danger-confirm-bg: #DC2626;
      --button-danger-confirm-text: #FFFFFF;
      --page-bg-gradient: radial-gradient(circle, #27272A 0%, #18181B 100%);
    }

    html, body { height: 100%; margin: 0; }
    body { 
      font-family: 'Inter', sans-serif; 
      background: var(--page-bg-gradient); 
      color: var(--text-color); 
      line-height: 1.5; 
      display: grid; 
      place-content: center; 
      padding: 1rem; 
      box-sizing: border-box;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    .main-content { width: 100%; }
    .container { max-width: 350px; width: 100%; margin: 0 auto; background-color: var(--card-bg-color); border-radius: 12px; box-shadow: var(--card-box-shadow); overflow: hidden; display: flex; flex-direction: column; }
    
    .header-area { 
      padding: 0 1.5rem; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      border-bottom: 1px solid var(--divider-color);
      height: 70px;
    }
    .main-title-group { display: flex; align-items: center; gap: 12px; overflow: hidden; }
    .header-image {
      height: 33px;
      border-radius: 4px;
      object-fit: contain;
      flex-shrink: 0;
    }
    .main-title { 
      font-size: var(--main-title-font-size, 1.70rem); 
      font-weight: 700; 
      color: var(--title-color); 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin: 0;
    }
    #settingsBtn { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--icon-color); transition: background-color 0.2s, color 0.2s; }
    #settingsBtn:hover { background-color: var(--icon-hover-bg); color: var(--icon-hover-color); }
    #settingsBtn i { font-size: 1.5rem; }

    .station-list {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      padding: 1rem;
      max-height: 528px;
      overflow-y: auto;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
    }
    .station-list::-webkit-scrollbar { display: none; }

    .station-list li {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      direction: ltr;
    }
    .station-list li.active {
      background-color: var(--station-item-active-bg);
    }
    .station-list li.active .station-logo {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.3s ease;
    }

    .station-logo {
      width: var(--station-logo-width, 58px);
      height: var(--station-logo-height, 58px);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      object-fit: cover;
      flex-shrink: 0;
      pointer-events: none;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .station-name-text {
      font-size: var(--station-name-font-size, 0.875rem);
      font-weight: 500;
      text-align: center;
      color: var(--text-color);
      width: 100%;
      word-break: break-word;
      pointer-events: none;
    }
    li.active .station-name-text {
      font-weight: 700;
      color: var(--station-item-active-text);
    }
    
    .edit-btn {
      position: absolute;
      top: 0;
      left: 0;
      background: none;
      border: none;
      color: var(--icon-color);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }
    .edit-btn:hover {
      background-color: var(--icon-hover-bg);
      color: var(--icon-hover-color);
    }
    .edit-btn i {
      font-size: 1.25rem;
    }
    
    .station-list li.show-edit-btn .edit-btn {
        opacity: 1;
        visibility: visible;
    }

    .hidden { display: none !important; }

    .station-list li.sortable-ghost {
      opacity: 0.5;
    }
    
    #audioPlayerContainer { padding: 0 1rem; border-top: 1px solid var(--divider-color); min-height: 70px; box-sizing: border-box; display: flex; align-items: center; justify-content: center;}
    .plyr--audio { border-radius: 6px !important; width: 100%; }
    #audioPlayerContainer .plyr__progress, #audioPlayerContainer .plyr__time { display: none; }
    #audioPlayerContainer .plyr__controls { display: flex; justify-content: center !important; align-items: center; gap: 12px; }
    #audioPlayerContainer .plyr__controls button[data-plyr="play"] { order: -2; }
    #audioPlayerContainer .plyr__controls::before { content: 'LIVE'; color: #e11d48; font-size: 10px; font-weight: bold; background-color: rgba(225, 29, 72, 0.1); padding: 4px 8px; border-radius: 4px; order: -1; }
    .dark-mode .plyr--audio { --plyr-audio-controls-background: var(--card-bg-color); --plyr-audio-control-color: var(--icon-color); --plyr-audio-control-color-hover: var(--icon-hover-color); --plyr-audio-control-background-hover: var(--icon-hover-bg); --plyr-color-main: var(--button-primary-bg); }
    .dark-mode #audioPlayerContainer .plyr__controls::before { color: #f43f5e; background-color: rgba(244, 63, 94, 0.2); }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      display: grid;
      place-items: center;
      z-index: 1000;
      overflow-y: auto;
    }

    .modal-overlay-small {
      align-items: start;
      padding-top: 28vh;
    }

    .modal-content { position: relative; background-color: var(--card-bg-color); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 1rem; max-height: 90vh; overflow-y: auto; }
    .modal-title { font-size: 1.5rem; font-weight: 700; color: var(--title-color); }
    
    /* MODIFIED: More compact form styling */
    .modal-form { display: flex; flex-direction: column; gap: 0.9rem; }
    form.modal-form { margin-bottom: -0.3rem; }
    .modal-form label { display: block; font-weight: 500; margin-bottom: 0.3rem; }
    .modal-form input, .modal-form select { width: 100%; padding: 0.65rem 0.75rem; border: 1px solid var(--input-border-color); background-color: var(--input-bg-color); color: var(--text-color); border-radius: 6px; box-sizing: border-box; }
    .modal-form input[type="checkbox"] { width: auto; height: auto; }
    
    .modal-form .form-note { font-size: 0.8rem; color: var(--secondary-text-color); margin-top: 0.4rem; }
    .modal-form .modal-actions { margin-top: 0.5rem; }
    .modal-actions { display: flex; justify-content: center; gap: 0.75rem; }
    .modal-actions button, .settings-section button { padding: 0.6rem 1.2rem; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; transition: opacity 0.2s; }
    .modal-actions button:hover, .settings-section button:hover { opacity: 0.85; }
    .btn-primary { background-color: var(--button-primary-bg); color: var(--button-primary-text); }
    .btn-secondary { background-color: var(--button-secondary-bg); color: var(--button-secondary-text); }
    .btn-danger { background-color: var(--button-danger-bg); color: var(--button-danger-text); }
    .btn-danger-confirm { background-color: var(--button-danger-confirm-bg); color: var(--button-danger-confirm-text); }
    .modal-close-btn { position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; color: var(--icon-color); cursor: pointer; padding: 0.5rem; border-radius: 50%; }
    .modal-close-btn:hover { background-color: var(--icon-hover-bg); color: var(--icon-hover-color); }
    .modal-close-btn i { font-size: 1.5rem; }
    .settings-section { display: flex; flex-direction: column; gap: 0.75rem; }
    .settings-section-title { font-weight: 700; font-size: 1.1rem; color: var(--title-color); border-bottom: 1px solid var(--divider-color); padding-bottom: 0.5rem; margin-bottom: 0.5rem; }
    .confirm-text {
      font-size: 1.1rem;
      margin: 0.3rem 0 1.3rem;
      text-align: left;
    }
    .export-options { display: flex; justify-content: space-around; padding: 0.5rem 0; }
    .export-options label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
    .form-row { display: flex; gap: 1rem; }
    .form-row > div { flex: 1; }
    #personalizationModal input::placeholder { opacity: 0.7; }
    #personalizationModal input::-webkit-input-placeholder { opacity: 0.7; }
    #personalizationModal input::-moz-placeholder { opacity: 0.7; }
    #personalizationModal input:-ms-input-placeholder { opacity: 0.7; }
    #personalizationModal input:-moz-placeholder { opacity: 0.7; }
    
    /* RTL Styles for Arabic Language */
    body.lang-ar .modal-content { direction: rtl; }
    body.lang-ar .modal-close-btn { right: auto; left: 0.75rem; }
    body.lang-ar #editStationForm .modal-actions { flex-direction: row-reverse; }
    body.lang-ar .confirm-text { text-align: right; }

    /* Styles for the VIDEO popup player */
    .video-popup {
        position: fixed;
        z-index: 3000;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: flex-start;
        padding-top: 20vh;
        cursor: pointer;
    }
    .video-popup.active {
        display: flex;
    }
    .video-popup-content {
        position: relative;
        background-color: transparent;
        width: 95%;
        max-width: 800px;
        touch-action: none;
        cursor: grab;
    }
    .video-popup-content.dragging {
        cursor: grabbing;
        user-select: none;
    }
    .plyr--video {
        overflow: hidden;
        border-radius: 12px;
    }
    
    #importOptionsModal .modal-title,
    #exportOptionsModal .modal-title {
      margin-bottom: 0.7rem;
    }
  </style>
</head>
<body>

  <main class="main-content">
    <div class="container">
      <div class="header-area">
        <div class="main-title-group">
          <img id="headerImage" class="header-image" style="display: none;">
          <h1 id="mainTitle" class="main-title" data-lang-key="pageTitle">Jordan Radios</h1>
        </div>
        <button id="settingsBtn" title="Settings"><i class="ph ph-gear"></i></button>
      </div>
      <ul id="stationList" class="station-list"></ul>
      <div id="audioPlayerContainer"><audio id="audioPlayer"></audio></div>
    </div>
  </main>
  
  <!-- Edit Station Modal -->
  <div id="stationModal" class="modal-overlay hidden">
    <div class="modal-content">
      <button id="closeModalBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
      <div style="display: flex; align-items: center; gap: 1rem;"><img id="modalStationImage" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;"><h3 id="modalStationName" class="modal-title"></h3></div>
      <form id="editStationForm" class="modal-form">
        <div><label for="editStationName" data-lang-key="stationNameLabel">Station Name</label><input type="text" id="editStationName" required></div>
        <div><label for="editStreamUrl" data-lang-key="streamUrlLabel">Stream URL</label><input type="text" id="editStreamUrl" required></div>
        <div><label for="editLogoUrl" data-lang-key="logoUrlLabel">Logo URL</label><input type="text" id="editLogoUrl"></div>
        <div><label for="editStationDescription" data-lang-key="stationDescriptionLabel">Additional Info</label><input type="text" id="editStationDescription"></div>
        <div>
            <label for="editMediaType" data-lang-key="mediaTypeLabel">Media Type</label>
            <select id="editMediaType">
                <option value="audio" data-lang-key="mediaTypeAudio">Audio</option>
                <option value="video" data-lang-key="mediaTypeVideo">Video</option>
            </select>
        </div>
        <div>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0;">
                <input type="checkbox" id="editUseProxy">
                <span data-lang-key="useProxyLabel">Use Proxy for this station</span>
            </label>
        </div>
        <div class="modal-actions">
            <button type="button" id="deleteStationBtn" class="btn-danger" data-lang-key="deleteBtn">Delete</button>
            <button type="submit" class="btn-primary" data-lang-key="saveBtn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Station Modal -->
  <div id="addStationModal" class="modal-overlay hidden">
      <div class="modal-content">
        <button id="closeAddModalBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
        <h3 class="modal-title" data-lang-key="addStationModalTitle">Add New Station</h3>
        <form id="addStationForm" class="modal-form">
          <div><label for="addStationNameInput" data-lang-key="stationNameLabel">Station Name</label><input type="text" id="addStationNameInput" required></div>
          <div><label for="addStreamUrl" data-lang-key="streamUrlLabel">Stream URL</label><input type="text" id="addStreamUrl" required></div>
          <div><label for="addLogoUrl" data-lang-key="logoUrlLabel">Logo URL</label><input type="text" id="addLogoUrl"></div>
          <div><label for="addStationDescription" data-lang-key="stationDescriptionLabel">Additional Info</label><input type="text" id="addStationDescription"></div>
          <div>
            <label for="addMediaType" data-lang-key="mediaTypeLabel">Media Type</label>
            <select id="addMediaType">
                <option value="audio" data-lang-key="mediaTypeAudio">Audio</option>
                <option value="video" data-lang-key="mediaTypeVideo">Video</option>
            </select>
          </div>
          <div>
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0;">
                  <input type="checkbox" id="addUseProxy">
                  <span data-lang-key="useProxyLabel">Use Proxy for this station</span>
              </label>
          </div>
          <div class="modal-actions"><button type="submit" class="btn-primary" data-lang-key="addStationBtn">Add Station</button></div>
        </form>
      </div>
  </div>
  
  <!-- Other modals... -->
  <div id="settingsModal" class="modal-overlay hidden">
    <div class="modal-content">
        <button id="closeSettingsBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
        <h3 class="modal-title" data-lang-key="settingsTitle">Settings</h3>
        <div class="settings-section">
            <h4 class="settings-section-title" data-lang-key="appearanceTitle">Appearance</h4>
            <button id="themeToggleBtn" class="btn-secondary"></button>
            <button id="langToggleBtn" class="btn-secondary"></button>
            <button id="personalizeBtn" class="btn-secondary" data-lang-key="personalizeBtn">Personalize UI</button>
        </div>
        <div class="settings-section">
            <h4 class="settings-section-title" data-lang-key="manageListTitle">Manage List</h4>
            <button id="addStationBtn" class="btn-secondary" data-lang-key="addStationBtn">Add New Station</button>
            <button id="openImportOptionsBtn" class="btn-secondary" data-lang-key="importBtn">Import...</button>
            <button id="openExportOptionsBtn" class="btn-secondary" data-lang-key="exportBtn">Export...</button>
            <input type="file" id="fileInput" accept=".json,.m3u,.m3u8" class="hidden">
        </div>
        <div class="settings-section">
            <button id="resetBtn" class="btn-danger" data-lang-key="resetBtn">Reset to Default</button>
        </div>
    </div>
  </div>
  <div id="personalizationModal" class="modal-overlay hidden">
      <div class="modal-content">
        <button id="closePersonalizationModalBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
        <h3 class="modal-title" data-lang-key="personalizationTitle">Personalization</h3>
        <form id="personalizationForm" class="modal-form">
            <div>
                <label for="customTitleInput" data-lang-key="customTitleLabel">Custom Title</label>
                <input type="text" id="customTitleInput" data-lang-placeholder-key="customTitlePlaceholder">
            </div>
            <div>
                <label for="customImageUrlInput" data-lang-key="customImageUrlLabel">Custom Image URL</label>
                <input type="text" id="customImageUrlInput" data-lang-placeholder-key="customImageUrlPlaceholder">
            </div>
            <div>
                <div class="form-row">
                    <div>
                        <label for="customImageWidthInput" data-lang-key="customImageWidthLabel">Image Width (px)</label>
                        <input type="number" id="customImageWidthInput" data-lang-placeholder-key="customImageWidthPlaceholder">
                    </div>
                    <div>
                        <label for="customImageHeightInput" data-lang-key="customImageHeightLabel">Image Height (px)</label>
                        <input type="number" id="customImageHeightInput" data-lang-placeholder-key="customImageHeightPlaceholder">
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="customTitleFontSizeInput" data-lang-key="titleFontSizeLabel">Title Font Size</label>
                    <input type="number" id="customTitleFontSizeInput" step="0.05" data-lang-placeholder-key="titleFontSizePlaceholder">
                </div>
                <div>
                    <label for="customStationFontSizeInput" data-lang-key="stationFontSizeLabel">Station Font Size</label>
                    <input type="number" id="customStationFontSizeInput" step="0.05" data-lang-placeholder-key="stationFontSizePlaceholder">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label for="customStationWidthInput" data-lang-key="stationLogoWidthLabel">Logo Width (px)</label>
                    <input type="number" id="customStationWidthInput" data-lang-placeholder-key="stationLogoWidthPlaceholder">
                </div>
                <div>
                    <label for="customStationHeightInput" data-lang-key="stationLogoHeightLabel">Logo Height (px)</label>
                    <input type="number" id="customStationHeightInput" data-lang-placeholder-key="stationLogoHeightPlaceholder">
                </div>
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn-primary" data-lang-key="saveBtn">Save</button>
            </div>
        </form>
      </div>
  </div>
  <div id="importOptionsModal" class="modal-overlay modal-overlay-small hidden">
      <div class="modal-content">
        <button id="closeImportOptionsBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
        <h3 class="modal-title" data-lang-key="importOptionsTitle">Choose Import Type</h3>
        <div class="modal-actions" style="flex-direction: column;">
            <button id="importStationsChoiceBtn" class="btn-secondary" data-lang-key="stationsListOnly">Stations List Only</button>
            <button id="importProfileChoiceBtn" class="btn-secondary" data-lang-key="fullProfileBackup">Stations & UI</button>
            <button id="importFromUrlChoiceBtn" class="btn-secondary" data-lang-key="importFromUrlBtn">Import from URL</button>
        </div>
      </div>
  </div>
  <div id="exportOptionsModal" class="modal-overlay modal-overlay-small hidden">
    <div class="modal-content">
        <button id="closeExportOptionsBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
        <h3 class="modal-title" data-lang-key="exportOptionsTitle">Choose Export Type</h3>
        <div id="exportContentTypeSelection">
            <div class="modal-actions" style="flex-direction: column;">
                <button id="exportStationsChoiceBtn" class="btn-secondary" data-lang-key="stationsListOnly">Stations List Only</button>
                <button id="exportProfileChoiceBtn" class="btn-secondary" data-lang-key="fullProfileBackup">Stations & UI</button>
            </div>
        </div>
        <div id="exportFormatSelection" class="hidden">
            <p class="confirm-text" data-lang-key="exportFormatQuestion">Choose the appropriate file type</p>
            <div class="modal-actions" style="flex-direction: column; gap: 0.75rem;">
                <button id="exportToJsonBtn" class="btn-secondary">JSON</button>
                <button id="exportToM3uBtn" class="btn-secondary">M3U</button>
                <button id="exportToM3u8Btn" class="btn-secondary">M3U8</button>
            </div>
        </div>
    </div>
  </div>
  <div id="importUrlModal" class="modal-overlay modal-overlay-small hidden">
    <div class="modal-content">
        <button id="closeImportUrlModalBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
        <h3 class="modal-title" data-lang-key="importFromUrlTitle">Import from URL</h3>
        <form id="importUrlForm" class="modal-form">
            <div>
                <label for="importUrlInput">URL</label>
                <input type="url" id="importUrlInput" placeholder="https://example.com/stations.json" required>
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn-primary" data-lang-key="importBtn">Import</button>
            </div>
        </form>
    </div>
  </div>
  <div id="mediaTypeSelectModal" class="modal-overlay modal-overlay-small hidden">
    <div class="modal-content">
        <button id="closeMediaTypeSelectBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
        <h3 class="modal-title" data-lang-key="importMediaTypeTitle">Select Media Type</h3>
        <p class="confirm-text" data-lang-key="importMediaTypeConfirmText">Please classify the imported list.</p>
        <div class="modal-actions">
            <button id="setMediaTypeAudioBtn" class="btn-secondary" data-lang-key="mediaTypeAudio">Audio</button>
            <button id="setMediaTypeVideoBtn" class="btn-secondary" data-lang-key="mediaTypeVideo">Video</button>
        </div>
    </div>
  </div>
  <div id="importConfirmModal" class="modal-overlay modal-overlay-small hidden">
      <div class="modal-content">
          <button id="closeImportConfirmBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
          <h3 class="modal-title" data-lang-key="importModalTitle">Import List</h3>
          <p class="confirm-text" data-lang-key="importConfirmText">New list ready. Merge with current list or replace it?</p>
          <div class="modal-actions">
              <button id="mergeBtn" class="btn-secondary" data-lang-key="mergeBtn">Merge</button>
              <button id="replaceBtn" class="btn-secondary" data-lang-key="replaceBtn">Replace</button>
          </div>
      </div>
  </div>
  <div id="deleteConfirmModal" class="modal-overlay modal-overlay-small hidden">
      <div class="modal-content">
          <button id="cancelDeleteBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
          <h3 class="modal-title" data-lang-key="deleteModalTitle">Confirm Deletion</h3>
          <p id="deleteConfirmText" class="confirm-text"></p>
          <div class="modal-actions">
              <button id="confirmDeleteBtn" class="btn-danger-confirm" data-lang-key="confirmBtn">Confirm</button>
          </div>
      </div>
  </div>
  <div id="resetConfirmModal" class="modal-overlay modal-overlay-small hidden">
      <div class="modal-content">
          <button id="cancelResetBtn" class="modal-close-btn"><i class="ph ph-x"></i></button>
          <h3 class="modal-title" data-lang-key="resetModalTitle">Confirm Reset</h3>
          <p class="confirm-text" data-lang-key="resetConfirmText">Are you sure? This will delete all your custom changes and restore the original list.</p>
          <div class="modal-actions">
              <button id="confirmResetBtn" class="btn-danger-confirm" data-lang-key="confirmBtn">Confirm</button>
          </div>
      </div>
  </div>
  <div id="video-popup" class="video-popup">
      <div id="video-popup-content" class="video-popup-content">
          <div id="video-player-container"></div>
      </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <script>
    let stations = [];
    
    const DEFAULT_HEADER_IMAGE = 'https://i.postimg.cc/W3SKLHK1/3170535f785530d2ec9dd76ce2204339.png';
    const DEFAULT_HEADER_IMAGE_HEIGHT = '33';

    const getEl = id => document.getElementById(id);
    const mainTitle = getEl("mainTitle"), headerImage = getEl("headerImage");
    const personalizationModal = getEl("personalizationModal"), personalizeBtn = getEl("personalizeBtn"), closePersonalizationModalBtn = getEl("closePersonalizationModalBtn"), personalizationForm = getEl("personalizationForm");
    const customTitleInput = getEl("customTitleInput"), customImageUrlInput = getEl("customImageUrlInput"), customImageWidthInput = getEl("customImageWidthInput"), customImageHeightInput = getEl("customImageHeightInput"), customTitleFontSizeInput = getEl("customTitleFontSizeInput"), customStationFontSizeInput = getEl("customStationFontSizeInput"), customStationWidthInput = getEl("customStationWidthInput"), customStationHeightInput = getEl("customStationHeightInput");
    const body = document.body, stationListUL = getEl("stationList"), audioPlayerContainer = getEl("audioPlayerContainer"),
        audioPlayerEl = getEl("audioPlayer"), stationModal = getEl('stationModal'), closeModalBtn = getEl('closeModalBtn'),
        editStationForm = getEl('editStationForm'), modalStationImage = getEl('modalStationImage'),
        modalStationName = getEl('modalStationName'), editStationName = getEl('editStationName'),
        editStreamUrl = getEl('editStreamUrl'), editLogoUrl = getEl('editLogoUrl'), editStationDescription = getEl('editStationDescription'), editMediaType = getEl('editMediaType'), editUseProxy = getEl('editUseProxy'),
        deleteStationBtn = getEl('deleteStationBtn'), settingsBtn = getEl('settingsBtn'), settingsModal = getEl('settingsModal'),
        closeSettingsBtn = getEl('closeSettingsBtn'), themeToggleBtn = getEl('themeToggleBtn'), langToggleBtn = getEl('langToggleBtn'),
        addStationBtn = getEl('addStationBtn'), 
        openImportOptionsBtn = getEl('openImportOptionsBtn'), openExportOptionsBtn = getEl('openExportOptionsBtn'),
        fileInput = getEl('fileInput'), 
        resetBtn = getEl('resetBtn'), addStationModal = getEl('addStationModal'), closeAddModalBtn = getEl('closeAddModalBtn'),
        addStationForm = getEl('addStationForm'), addStationNameInput = getEl('addStationNameInput'),
        addStreamUrl = getEl('addStreamUrl'), addLogoUrl = getEl('addLogoUrl'), addStationDescription = getEl('addStationDescription'), addMediaType = getEl('addMediaType'), addUseProxy = getEl('addUseProxy'),
        importConfirmModal = getEl('importConfirmModal'), closeImportConfirmBtn = getEl('closeImportConfirmBtn'),
        mergeBtn = getEl('mergeBtn'), replaceBtn = getEl('replaceBtn'),
        deleteConfirmModal = getEl('deleteConfirmModal'), cancelDeleteBtn = getEl('cancelDeleteBtn'),
        confirmDeleteBtn = getEl('confirmDeleteBtn'), deleteConfirmText = getEl('deleteConfirmText'),
        resetConfirmModal = getEl('resetConfirmModal'), cancelResetBtn = getEl('cancelResetBtn'),
        confirmResetBtn = getEl('confirmResetBtn'),
        importOptionsModal = getEl('importOptionsModal'), closeImportOptionsBtn = getEl('closeImportOptionsBtn'), importStationsChoiceBtn = getEl('importStationsChoiceBtn'), importProfileChoiceBtn = getEl('importProfileChoiceBtn'),
        exportOptionsModal = getEl('exportOptionsModal'), closeExportOptionsBtn = getEl('closeExportOptionsBtn'), exportStationsChoiceBtn = getEl('exportStationsChoiceBtn'), exportProfileChoiceBtn = getEl('exportProfileChoiceBtn'),
        exportContentTypeSelection = getEl('exportContentTypeSelection'), exportFormatSelection = getEl('exportFormatSelection'),
        exportToJsonBtn = getEl('exportToJsonBtn'), exportToM3uBtn = getEl('exportToM3uBtn'), exportToM3u8Btn = getEl('exportToM3u8Btn');
    const importFromUrlChoiceBtn = getEl('importFromUrlChoiceBtn'), importUrlModal = getEl('importUrlModal'), closeImportUrlModalBtn = getEl('closeImportUrlModalBtn'), importUrlForm = getEl('importUrlForm'), importUrlInput = getEl('importUrlInput');
    const mediaTypeSelectModal = getEl('mediaTypeSelectModal'), closeMediaTypeSelectBtn = getEl('closeMediaTypeSelectBtn'), setMediaTypeAudioBtn = getEl('setMediaTypeAudioBtn'), setMediaTypeVideoBtn = getEl('setMediaTypeVideoBtn');
    
    const videoPopup = getEl('video-popup'), videoPopupContent = getEl('video-popup-content'), videoPlayerContainer = getEl('video-player-container');
    const audioPlayer = new Plyr(audioPlayerEl, {});
    let videoPlayer = null, hlsAudio = null, hlsVideo = null;
    let currentEditingIndex = null, importedStations = [];
    let currentLang = 'en';
    
    const translations = {
        useProxyLabel: { en: 'Use Proxy for this station', ar: 'استخدام بروكسي لهذه المحطة' },
        stationDescriptionLabel: { en: 'Additional Info', ar: 'معلومات إضافية' },
        importMediaTypeTitle: { en: 'Select Media Type', ar: 'اختر نوع الوسائط' },
        importMediaTypeConfirmText: { en: 'Please classify the imported list.', ar: 'يرجى تصنيف القائمة المستوردة.' },
        mediaTypeLabel: { en: 'Media Type', ar: 'نوع الوسائط' },
        mediaTypeAudio: { en: 'Audio', ar: 'صوت' },
        mediaTypeVideo: { en: 'Video', ar: 'فيديو' },
        pageTitle: { en: 'Jordan Radios', ar: 'الإذاعات الأردنية' },
        personalizeBtn: { en: 'Personalize UI', ar: 'تخصيص الواجهة' },
        personalizationTitle: { en: 'Personalization', ar: 'تخصيص الواجهة' },
        customTitleLabel: { en: 'Custom Title', ar: 'عنوان مخصص' },
        customImageUrlLabel: { en: 'Custom Image URL', ar: 'رابط صورة مخصصة' },
        customTitlePlaceholder: { en: 'e.g., My Favorite Radios', ar: 'مثال: إذاعاتي المفضلة' },
        customImageUrlPlaceholder: { en: 'e.g., https://example.com/logo.png', ar: 'مثال: https://example.com/logo.png' },
        customImageWidthLabel: { en: 'Image Width', ar: 'عرض الصورة' },
        customImageHeightLabel: { en: 'Image Height', ar: 'ارتفاع الصورة' },
        customImageWidthPlaceholder: { en: 'Default: auto', ar: 'الافتراضي: تلقائي' },
        customImageHeightPlaceholder: { en: 'Default: 33', ar: 'الافتراضي: 33' },
        titleFontSizeLabel: { en: 'Title Font Size', ar: 'حجم خط العنوان' },
        stationFontSizeLabel: { en: 'Station Font Size', ar: 'حجم خط الإذاعة' },
        stationLogoWidthLabel: { en: 'Logo Width', ar: 'عرض الشعار' },
        stationLogoHeightLabel: { en: 'Logo Height', ar: 'ارتفاع الشعار' },
        titleFontSizePlaceholder: { en: 'Default: 1.70', ar: 'الافتراضي: 1.70' },
        stationFontSizePlaceholder: { en: 'Default: 0.875', ar: 'الافتراضي: 0.875' },
        stationLogoWidthPlaceholder: { en: 'Default: 58', ar: 'الافتراضي: 58' },
        stationLogoHeightPlaceholder: { en: 'Default: 58', ar: 'الافتراضي: 58' },
        importOptionsTitle: { en: 'Choose Import Type', ar: 'اختر نوع الاستيراد' },
        exportOptionsTitle: { en: 'Choose Export Type', ar: 'اختر نوع التصدير' },
        stationsListOnly: { en: 'Stations List Only', ar: 'قائمة المحطات فقط' },
        fullProfileBackup: { en: 'Stations & UI', ar: 'المحطات والواجهة' },
        importFromUrlBtn: { en: 'Import from URL', ar: 'استيراد من رابط' },
        importFromUrlTitle: { en: 'Import from URL', ar: 'استيراد من رابط' },
        exportFormatQuestion: { en: 'Choose the appropriate file type', ar: 'اختر نوع الملف المناسب' },
        settingsTitle: { en: 'Settings', ar: 'الإعدادات' },
        appearanceTitle: { en: 'Appearance', ar: 'المظهر' },
        manageListTitle: { en: 'Manage List', ar: 'إدارة القائمة' },
        addStationBtn: { en: 'Add New Station', ar: 'إضافة محطة جديدة' },
        importBtn: { en: 'Import', ar: 'استيراد' },
        exportBtn: { en: 'Export', ar: 'تصدير' },
        resetBtn: { en: 'Reset to Default', ar: 'إعادة للوضع الافتراضي' },
        themeToggleLight: { en: 'Switch to Light Mode', ar: 'التحويل للوضع النهاري' },
        themeToggleDark: { en: 'Switch to Dark Mode', ar: 'التحويل للوضع الليلي' },
        langToggle: { en: 'Switch to Arabic', ar: 'التحويل إلى الإنجليزية' },
        streamUrlLabel: { en: 'Stream URL', ar: 'رابط البث' },
        logoUrlLabel: { en: 'Logo URL', ar: 'رابط الشعار' },
        deleteBtn: { en: 'Delete', ar: 'حذف' },
        saveBtn: { en: 'Save', ar: 'حفظ' },
        addStationModalTitle: { en: 'Add New Station', ar: 'إضافة محطة جديدة' },
        stationNameLabel: { en: 'Station Name', ar: 'اسم المحطة' },
        importModalTitle: { en: 'Import List', ar: 'استيراد قائمة' },
        importConfirmText: { en: 'New list ready. Merge with current list or replace it?', ar: 'القائمة الجديدة جاهزة. هل تريد دمجها مع الحالية أم استبدالها؟' },
        mergeBtn: { en: 'Merge', ar: 'دمج' },
        replaceBtn: { en: 'Replace', ar: 'استبدال' },
        deleteModalTitle: { en: 'Confirm Deletion', ar: 'تأكيد الحذف' },
        confirmBtn: { en: 'Confirm', ar: 'تأكيد' },
        resetModalTitle: { en: 'Confirm Reset', ar: 'تأكيد إعادة التعيين' },
        resetConfirmText: { en: 'Are you sure? This will delete all your custom changes and restore the original list.', ar: 'هل أنت متأكد؟ سيتم حذف كل التغييرات المخصصة واستعادة القائمة الأصلية.' },
        alertRequired: { en: 'Station Name and Stream URL are required.', ar: 'اسم المحطة ورابط البث مطلوبان.' },
        alertUrlRequired: { en: 'URL is required.', ar: 'الرابط مطلوب.' },
        alertFetchError: { en: 'Failed to fetch from URL.', ar: 'فشل جلب البيانات من الرابط.' },
        alertUnsupported: { en: 'Unsupported file type.', ar: 'نوع الملف غير مدعوم.' },
        alertInvalid: { en: 'File is empty or invalid.', ar: 'الملف فارغ أو غير صالح.' },
        alertParseFail: { en: 'Failed to parse the file.', ar: 'فشل في تحليل الملف.' },
        deleteConfirmText: { en: 'Are you sure you want to delete "{stationName}"?', ar: 'هل أنت متأكد من حذف "{stationName}"؟' }
    };
    
    function stopVideoPlayer() { if (hlsVideo) { hlsVideo.destroy(); hlsVideo = null; } if (videoPlayer) { videoPlayer.destroy(); videoPlayer = null; } videoPlayerContainer.innerHTML = ''; videoPopup.classList.remove('active'); }
    function playVideoStream(station) {
        stopAudioPlayer();
        const mediaElement = document.createElement('video');
        mediaElement.playsinline = true;
        mediaElement.controls = true;
        videoPlayerContainer.innerHTML = '';
        videoPlayerContainer.appendChild(mediaElement);
        videoPopup.classList.add('active');
        if (station.url.includes('.m3u8') && Hls.isSupported()) {
            hlsVideo = new Hls({ abrEwmaDefaultEstimate: 500000, startLevel: -1 });
            hlsVideo.loadSource(station.url);
            hlsVideo.attachMedia(mediaElement);
            hlsVideo.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                const plyrOptions = { i18n: { qualityLabel: { ...data.levels.reduce((labels, level) => { const bitrate = level.bitrate; labels[bitrate] = `${(bitrate / 1000000).toFixed(1)} Mbps`; return labels; }, {}) } } };
                if (data.levels.length > 1) {
                    plyrOptions.quality = { default: data.levels[data.levels.length - 1].bitrate, options: [...data.levels].reverse().map(level => level.bitrate), forced: true, onChange: (bitrate) => { hlsVideo.levels.forEach((level, i) => { if (level.bitrate === bitrate) hlsVideo.currentLevel = i; }); }, };
                }
                videoPlayer = new Plyr(mediaElement, plyrOptions);
                videoPlayer.play().catch(e => console.error("Video play error:", e));
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({ title: getStationName(station), artist: station.description || 'Live Video', album: 'Jordan Radios', artwork: [{ src: station.logoUrl || 'icon-1024.png', sizes: '512x512', type: 'image/png' }] });
                    navigator.mediaSession.setActionHandler('play', () => videoPlayer.play());
                    navigator.mediaSession.setActionHandler('pause', () => videoPlayer.pause());
                }
            });
            hlsVideo.on(Hls.Events.ERROR, (event, data) => {
                if (data.fatal) {
                    console.error('HLS Fatal Error:', data.type, data.details);
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR: hlsVideo.startLoad(); break;
                        case Hls.ErrorTypes.MEDIA_ERROR: hlsVideo.recoverMediaError(); break;
                        default: stopVideoPlayer(); break;
                    }
                }
            });
        } else {
            mediaElement.src = station.url;
            videoPlayer = new Plyr(mediaElement, {});
            videoPlayer.play().catch(e => console.error("Video play error:", e));
        }
    }
    function stopAudioPlayer() { audioPlayer.stop(); }
    function playAudioStream(station) { stopVideoPlayer(); if (hlsAudio) { hlsAudio.destroy(); hlsAudio = null; } const isM3U8 = station.url.includes('.m3u8'); audioPlayer.source = { type: 'audio', title: getStationName(station), sources: [{ src: station.url, type: isM3U8 ? 'application/x-mpegURL' : 'audio/mpeg' }] }; audioPlayer.play().catch(e => console.warn(`Audio error:`, e)); if ('mediaSession' in navigator) { navigator.mediaSession.metadata = new MediaMetadata({ title: getStationName(station), artist: station.description || 'Live Radio', album: 'Jordan Radios', artwork: [{ src: station.logoUrl || 'icon-1024.png', sizes: '512x512', type: 'image/png' }] }); navigator.mediaSession.setActionHandler('play', () => audioPlayer.play()); navigator.mediaSession.setActionHandler('pause', () => audioPlayer.pause()); } }
    
    const playStation = (li, station) => {
        const wasActive = li.classList.contains('active');
        if (wasActive) { if (station.type === 'video') { if(videoPlayer) videoPlayer.togglePlay(); } else { audioPlayer.togglePlay(); } return; }
        const oldActiveItem = stationListUL.querySelector("li.active");
        if (oldActiveItem) oldActiveItem.classList.remove("active");
        li.classList.add("active");
        const stationToPlay = JSON.parse(JSON.stringify(station));
        if (stationToPlay.proxied) {
            stationToPlay.url = `https://proxy.iofahmawi.workers.dev/?url=${encodeURIComponent(stationToPlay.url)}`;
        }
        if (stationToPlay.type === 'video') playVideoStream(stationToPlay); else playAudioStream(stationToPlay);
    };
    
    function setupDraggablePopup() { let isDragging = false, startY, currentTranslateY = 0; const dragStart = (e) => { if (e.target.closest('.plyr__controls')) return; isDragging = true; startY = e.pageY || e.touches[0].pageY; videoPopupContent.classList.add('dragging'); }; const dragMove = (e) => { if (!isDragging) return; e.preventDefault(); const currentY = e.pageY || e.touches[0].pageY; const newTranslateY = currentTranslateY + (currentY - startY); videoPopupContent.style.transform = `translateY(${newTranslateY}px)`; }; const dragEnd = (e) => { if (!isDragging) return; isDragging = false; videoPopupContent.classList.remove('dragging'); const endY = e.pageY || (e.changedTouches ? e.changedTouches[0].pageY : startY); currentTranslateY += (endY - startY); }; videoPopupContent.addEventListener('mousedown', dragStart); document.addEventListener('mousemove', dragMove); document.addEventListener('mouseup', dragEnd); videoPopupContent.addEventListener('touchstart', dragStart, { passive: false }); document.addEventListener('touchmove', dragMove, { passive: false }); document.addEventListener('touchend', dragEnd); videoPopup.addEventListener('click', e => { if (e.target === videoPopup) { stopVideoPlayer(); const activeItem = stationListUL.querySelector('li.active'); if (activeItem) activeItem.classList.remove('active'); } }); }
    const applyFontSizes = () => { const titleSize = localStorage.getItem('customTitleFontSize'); const stationSize = localStorage.getItem('customStationFontSize'); document.documentElement.style.setProperty('--main-title-font-size', titleSize ? `${titleSize}rem` : ''); document.documentElement.style.setProperty('--station-name-font-size', stationSize ? `${stationSize}rem` : ''); };
    const applyStationLogoSize = () => { const stationWidth = localStorage.getItem('customStationWidth'); const stationHeight = localStorage.getItem('customStationHeight'); document.documentElement.style.setProperty('--station-logo-width', stationWidth ? `${stationWidth}px` : ''); document.documentElement.style.setProperty('--station-logo-height', stationHeight ? `${stationHeight}px` : ''); };
    const applyCustomization = (title, imageUrl, width, height) => { if (title) { mainTitle.textContent = title; document.title = title; mainTitle.removeAttribute('data-lang-key'); } else { mainTitle.setAttribute('data-lang-key', 'pageTitle'); mainTitle.textContent = translations.pageTitle[currentLang]; document.title = "Web Jordan Radios"; } if (imageUrl) { headerImage.src = imageUrl; headerImage.style.display = 'block'; headerImage.style.height = height ? `${height}px` : DEFAULT_HEADER_IMAGE_HEIGHT + 'px'; headerImage.style.width = width ? `${width}px` : 'auto'; headerImage.style.maxWidth = 'none'; headerImage.style.objectFit = 'contain'; } else { headerImage.style.display = 'none'; } };
    const saveCustomization = (e) => { e.preventDefault(); const newTitle = customTitleInput.value.trim(); const newImageUrl = customImageUrlInput.value.trim(); const newWidth = customImageWidthInput.value.trim(); const newHeight = customImageHeightInput.value.trim(); const newTitleSize = customTitleFontSizeInput.value.trim(); const newStationSize = customStationFontSizeInput.value.trim(); const newStationWidth = customStationWidthInput.value.trim(); const newStationHeight = customStationHeightInput.value.trim(); localStorage.setItem('customTitle', newTitle); localStorage.setItem('customImageUrl', newImageUrl); localStorage.setItem('customImageWidth', newWidth); localStorage.setItem('customImageHeight', newHeight); localStorage.setItem('customTitleFontSize', newTitleSize); localStorage.setItem('customStationFontSize', newStationSize); localStorage.setItem('customStationWidth', newStationWidth); localStorage.setItem('customStationHeight', newStationHeight); applyCustomization(newTitle, newImageUrl, newWidth, newHeight); applyFontSizes(); applyStationLogoSize(); personalizationModal.classList.add('hidden'); };
    const openPersonalizationModal = () => { customTitleInput.value = localStorage.getItem('customTitle') ?? ''; customImageUrlInput.value = localStorage.getItem('customImageUrl') ?? ''; customImageWidthInput.value = localStorage.getItem('customImageWidth') ?? ''; customImageHeightInput.value = localStorage.getItem('customImageHeight') ?? ''; customTitleFontSizeInput.value = localStorage.getItem('customTitleFontSize') ?? ''; customStationFontSizeInput.value = localStorage.getItem('customStationFontSize') ?? ''; customStationWidthInput.value = localStorage.getItem('customStationWidth') ?? ''; customStationHeightInput.value = localStorage.getItem('customStationHeight') ?? ''; settingsModal.classList.add('hidden'); personalizationModal.classList.remove('hidden'); };
    const getStationName = (station) => { if (typeof station.name === 'object' && station.name !== null) { return station.name[currentLang] || station.name['en']; } return station.name; };
    const setLanguage = (lang) => { currentLang = lang; localStorage.setItem('language', lang); document.documentElement.lang = lang; body.classList.toggle('lang-ar', lang === 'ar'); document.querySelectorAll('[data-lang-key]').forEach(el => { const key = el.getAttribute('data-lang-key'); if (translations[key] && translations[key][lang]) { el.textContent = translations[key][lang]; } }); document.querySelectorAll('[data-lang-placeholder-key]').forEach(el => { const key = el.getAttribute('data-lang-placeholder-key'); if (translations[key] && translations[key][lang]) { el.placeholder = translations[key][lang]; } }); const savedTitle = localStorage.getItem('customTitle'); if (!savedTitle) { mainTitle.textContent = translations.pageTitle[lang]; } renderStationList(); updateThemeButtonText(); updateLangButtonText(); };
    const renderStationList = () => { const currentlyPlayingUrl = stationListUL.querySelector('li.active')?.dataset.url; stationListUL.innerHTML = ''; stations.forEach((station, index) => { const li = document.createElement("li"); li.dataset.index = index; if (station.url === currentlyPlayingUrl) { li.classList.add('active'); } li.dataset.url = station.url; const stationName = getStationName(station); li.innerHTML = `<img src="${station.logoUrl || 'icon-1024.png'}" class="station-logo" onerror="this.onerror=null;this.src='icon-1024.png';"><span class="station-name-text">${stationName}</span><button class="edit-btn"><i class="ph ph-dots-three-vertical"></i></button>`; li.addEventListener("click", (e) => { if (e.target.closest('.edit-btn')) return; playStation(li, station); }); const editBtn = li.querySelector('.edit-btn'); editBtn.addEventListener('click', (e) => { e.stopPropagation(); openEditModal(station, index); }); let hideTimer = null; li.addEventListener('mouseenter', () => { clearTimeout(hideTimer); document.querySelectorAll('.station-list li.show-edit-btn').forEach(item => item.classList.remove('show-edit-btn')); li.classList.add('show-edit-btn'); }); li.addEventListener('mouseleave', () => { hideTimer = setTimeout(() => { li.classList.remove('show-edit-btn'); }, 2000); }); li.addEventListener('touchstart', (e) => { if (e.target.closest('.edit-btn')) return; clearTimeout(hideTimer); const isAlreadyShown = li.classList.contains('show-edit-btn'); document.querySelectorAll('.station-list li.show-edit-btn').forEach(item => item.classList.remove('show-edit-btn')); if (!isAlreadyShown) { li.classList.add('show-edit-btn'); hideTimer = setTimeout(() => { li.classList.remove('show-edit-btn'); }, 4000); } }, { passive: true }); stationListUL.appendChild(li); }); };
    const openEditModal = (station, index) => { const stationName = getStationName(station); currentEditingIndex = index; modalStationImage.src = station.logoUrl; modalStationName.textContent = stationName; editStationName.value = stationName; editStreamUrl.value = station.url; editLogoUrl.value = station.logoUrl; editStationDescription.value = station.description || ''; editMediaType.value = station.type || 'audio'; editUseProxy.checked = station.proxied || false; stationModal.classList.remove('hidden'); };
    const saveStationChanges = e => { e.preventDefault(); if (currentEditingIndex === null) return; const station = stations[currentEditingIndex]; const newName = editStationName.value.trim(); const newUrl = editStreamUrl.value.trim(); if (!newName || !newUrl) return alert(translations.alertRequired[currentLang]); if (typeof station.name === 'object' && station.name !== null) { station.name[currentLang] = newName; } else { station.name = newName; } station.url = newUrl; station.logoUrl = editLogoUrl.value.trim(); station.description = editStationDescription.value.trim(); station.type = editMediaType.value; station.proxied = editUseProxy.checked; saveAndRerender(); closeEditModal(); };
    const saveNewStation = e => { e.preventDefault(); const name = addStationNameInput.value.trim(), url = addStreamUrl.value.trim(); if (!name || !url) return alert(translations.alertRequired[currentLang]); stations.push({ name: { en: name, ar: name }, url, logoUrl: addLogoUrl.value.trim(), description: addStationDescription.value.trim(), type: addMediaType.value, proxied: addUseProxy.checked }); saveAndRerender(); closeAddModal(); };
    const saveStations = () => localStorage.setItem('savedStations', JSON.stringify(stations));
    const saveAndRerender = () => { saveStations(); renderStationList(); };
    const openDeleteConfirm = (station, index) => { currentEditingIndex = index; const stationName = getStationName(station); deleteConfirmText.textContent = translations.deleteConfirmText[currentLang].replace('{stationName}', stationName); deleteConfirmModal.classList.remove('hidden'); };
    const closeEditModal = () => stationModal.classList.add('hidden');
    const closeDeleteConfirm = () => deleteConfirmModal.classList.add('hidden');
    const deleteStation = () => { if (currentEditingIndex === null) return; stations.splice(currentEditingIndex, 1); saveAndRerender(); closeEditModal(); closeDeleteConfirm(); };
    const openAddModal = () => { addStationForm.reset(); addStationModal.classList.remove('hidden'); };
    const closeAddModal = () => addStationModal.classList.add('hidden');
    const openSettingsModal = () => settingsModal.classList.remove('hidden');
    const closeSettingsModal = () => settingsModal.classList.add('hidden');
    const openResetConfirm = () => { closeSettingsModal(); resetConfirmModal.classList.remove('hidden'); };
    const closeResetConfirm = () => resetConfirmModal.classList.add('hidden');
    const resetList = () => { const keysToRemove = ['savedStations', 'customTitle', 'customImageUrl', 'customImageWidth', 'customImageHeight', 'customTitleFontSize', 'customStationFontSize', 'customStationWidth', 'customStationHeight']; keysToRemove.forEach(key => localStorage.removeItem(key)); location.reload(); };
    const updateThemeButtonText = () => { const key = body.classList.contains('dark-mode') ? 'themeToggleLight' : 'themeToggleDark'; themeToggleBtn.textContent = translations[key][currentLang]; };
    const updateLangButtonText = () => { langToggleBtn.textContent = currentLang === 'en' ? translations.langToggle.en : translations.langToggle.ar; };
    const enableDarkMode = () => { body.classList.add('dark-mode'); localStorage.setItem('theme', 'dark'); updateThemeButtonText(); };
    const disableDarkMode = () => { body.classList.remove('dark-mode'); localStorage.setItem('theme', 'light'); updateThemeButtonText(); };
    const toggleThemeAndClose = () => { (body.classList.contains('dark-mode') ? disableDarkMode() : enableDarkMode()); closeSettingsModal(); };
    const toggleLanguageAndClose = () => { const newLang = currentLang === 'en' ? 'ar' : 'en'; setLanguage(newLang); closeSettingsModal(); };
    const setImportedMediaType = (type) => { importedStations.forEach(station => station.type = type); mediaTypeSelectModal.classList.add('hidden'); importConfirmModal.classList.remove('hidden'); };
    const processImportedContent = (content, fileName) => { try { if (fileName.endsWith('.json')) { const data = JSON.parse(content); const rawStations = Array.isArray(data) ? data : (data.stations || [data]); const findValue = (obj, keys, def = '') => { for (const key of keys) { if (obj[key] && typeof obj[key] === 'string') return obj[key].trim(); } return def; }; importedStations = rawStations.map(station => { let name; if (typeof station.name === 'object' && station.name !== null) { name = station.name; } else { const nameStr = findValue(station, ['name', 'title'], 'Unknown'); name = { en: nameStr, ar: nameStr }; } const url = findValue(station, ['url', 'stream_url', 'streamUrl', 'stream']); if (!url) return null; return { name: name, url: url, logoUrl: findValue(station, ['logoUrl', 'logo', 'image', 'thumb']), description: findValue(station, ['description', 'info']), type: station.type, proxied: station.proxied || false }; }).filter(Boolean); } else if (fileName.match(/\.m3u8?$/i)) { importedStations = parseM3U(content); } else { return alert(translations.alertUnsupported[currentLang]); } if (!Array.isArray(importedStations) || !importedStations.length) return alert(translations.alertInvalid[currentLang]); mediaTypeSelectModal.classList.remove('hidden'); } catch (err) { alert(translations.alertParseFail[currentLang]); console.error("Import Error:", err); } };
    const parseM3U = (c) => { const lines = c.split('\n'), p = []; for (let i = 0; i < lines.length; i++) { if (lines[i].startsWith('#EXTINF')) { const info = lines[i], url = lines[++i]?.trim(); if (!url) continue; const name = (info.match(/tvg-name="([^"]+)"/) || info.match(/,(.+)$/))?.[1].trim() || 'Unknown', logo = (info.match(/tvg-logo="([^"]+)"/))?.[1].trim() || ''; p.push({ name: { en: name, ar: name }, logoUrl: logo, url, description: '' }); } } return p; };
    const handleFileImport = (e) => { const file = e.target.files[0]; if (!file) return; const importType = e.target.dataset.importType; closeSettingsModal(); const reader = new FileReader(); reader.onload = (ev) => { if (importType === 'profile') { try { const data = JSON.parse(ev.target.result); if (data.profile && Array.isArray(data.stations)) { localStorage.setItem('savedStations', JSON.stringify(data.stations)); const { title, imageUrl, imageWidth, imageHeight, titleFontSize, stationFontSize, stationWidth, stationHeight, theme, language } = data.profile; const setItemIfDefined = (key, value) => { value ? localStorage.setItem(key, value) : localStorage.removeItem(key); }; setItemIfDefined('customTitle', title); setItemIfDefined('customImageUrl', imageUrl); setItemIfDefined('customImageWidth', imageWidth); setItemIfDefined('customImageHeight', imageHeight); setItemIfDefined('customTitleFontSize', titleFontSize); setItemIfDefined('customStationFontSize', stationFontSize); setItemIfDefined('customStationWidth', stationWidth); setItemIfDefined('customStationHeight', stationHeight); setItemIfDefined('theme', theme); setItemIfDefined('language', language); location.reload(); return; } } catch (err) { /* Fall through */ } } processImportedContent(ev.target.result, file.name); }; reader.readAsText(file); fileInput.value = ''; };
    const handleUrlImport = async (e) => { e.preventDefault(); const url = importUrlInput.value.trim(); if (!url) return alert(translations.alertUrlRequired[currentLang]); try { const response = await fetch(url); if (!response.ok) throw new Error('Network response not ok'); const content = await response.text(); closeImportUrlModal(); processImportedContent(content, url); } catch (error) { console.error("Fetch error:", error); alert(translations.alertFetchError[currentLang]); } };
    const mergeLists = () => { const urls = new Set(stations.map(s => s.url)); stations.push(...importedStations.filter(s => !urls.has(s.url))); saveAndRerender(); closeImportConfirmModal(); };
    const replaceList = () => { stations = importedStations; saveAndRerender(); closeImportConfirmModal(); };
    const closeImportConfirmModal = () => importConfirmModal.classList.add('hidden');
    const handleExportStationsAsJson = () => { const filename = `stations_list.json`; const content = JSON.stringify(stations, null, 2); downloadFile(content, filename, 'application/json'); closeExportOptionsModal(); };
    const handleExportProfile = () => { const profileData = { profile: { title: localStorage.getItem('customTitle') || '', imageUrl: localStorage.getItem('customImageUrl') || '', imageWidth: localStorage.getItem('customImageWidth') || '', imageHeight: localStorage.getItem('customImageHeight') || '', titleFontSize: localStorage.getItem('customTitleFontSize') || '', stationFontSize: localStorage.getItem('customStationFontSize') || '', stationWidth: localStorage.getItem('customStationWidth') || '', stationHeight: localStorage.getItem('customStationHeight') || '', theme: localStorage.getItem('theme') || 'light', language: localStorage.getItem('language') || 'en' }, stations: stations }; const content = JSON.stringify(profileData, null, 2); downloadFile(content, 'radio_profile.json', 'application/json'); closeExportOptionsModal(); };
    const exportToPlaylist = (format) => { let content = '#EXTM3U\n'; stations.forEach(station => { const stationName = getStationName(station).replace(/"/g, "'"); content += `#EXTINF:-1 tvg-name="${stationName}" tvg-logo="${station.logoUrl || ''}",${stationName}\n`; content += `${station.url}\n`; }); const filename = `stations_list.${format}`; downloadFile(content, filename, 'audio/x-mpegurl'); closeExportOptionsModal(); };
    const downloadFile = (content, fileName, contentType) => { const a = document.createElement("a"), file = new Blob([content], { type: contentType }); a.href = URL.createObjectURL(file); a.download = fileName; a.click(); URL.revokeObjectURL(a.href); };
    const openImportOptionsModal = () => { settingsModal.classList.add('hidden'); importOptionsModal.classList.remove('hidden'); };
    const closeImportOptionsModal = () => importOptionsModal.classList.add('hidden');
    const openExportOptionsModal = () => { settingsModal.classList.add('hidden'); exportContentTypeSelection.classList.remove('hidden'); exportFormatSelection.classList.add('hidden'); exportOptionsModal.classList.remove('hidden'); };
    const closeExportOptionsModal = () => exportOptionsModal.classList.add('hidden');
    const openImportUrlModal = () => { closeImportOptionsModal(); importUrlModal.classList.remove('hidden'); };
    const closeImportUrlModal = () => { importUrlForm.reset(); importUrlModal.classList.add('hidden'); };

    const initialize = async () => {
        const savedStationsJSON = localStorage.getItem('savedStations');
        if (savedStationsJSON) {
            stations = JSON.parse(savedStationsJSON);
        } else {
            try {
                // MODIFIED: Changed file name
                const response = await fetch('https://iofahmawi.github.io/jo-radios/stations_list.json');
                if (!response.ok) { throw new Error('Network response was not ok'); }
                stations = await response.json();
                saveStations();
            } catch (error) {
                console.error("Failed to fetch default stations:", error);
                stations = [];
            }
        }
        const savedTitle = localStorage.getItem('customTitle');
        const savedImageUrl = localStorage.getItem('customImageUrl');
        const savedImageWidth = localStorage.getItem('customImageWidth');
        const savedImageHeight = localStorage.getItem('customImageHeight');
        if (localStorage.getItem('customImageUrl') !== null || localStorage.getItem('customTitle') !== null) {
            applyCustomization(savedTitle, savedImageUrl, savedImageWidth, savedImageHeight);
        } else {
            headerImage.src = DEFAULT_HEADER_IMAGE;
            headerImage.style.display = 'block';
            headerImage.style.height = DEFAULT_HEADER_IMAGE_HEIGHT + 'px';
            headerImage.style.width = 'auto';
        }
        if (localStorage.getItem('theme') === 'dark') enableDarkMode(); else disableDarkMode();
        personalizeBtn.addEventListener('click', openPersonalizationModal);
        closePersonalizationModalBtn.addEventListener('click', () => personalizationModal.classList.add('hidden'));
        personalizationModal.addEventListener('click', e => e.target === personalizationModal && personalizationModal.classList.add('hidden'));
        personalizationForm.addEventListener('submit', saveCustomization);
        closeModalBtn.addEventListener('click', closeEditModal);
        closeAddModalBtn.addEventListener('click', closeAddModal);
        closeSettingsBtn.addEventListener('click', closeSettingsModal);
        closeImportConfirmBtn.addEventListener('click', closeImportConfirmModal);
        cancelDeleteBtn.addEventListener('click', closeDeleteConfirm);
        cancelResetBtn.addEventListener('click', closeResetConfirm);
        stationModal.addEventListener('click', e => e.target === stationModal && closeEditModal());
        addStationModal.addEventListener('click', e => e.target === addStationModal && closeAddModal());
        settingsModal.addEventListener('click', e => e.target === settingsModal && closeSettingsModal());
        importConfirmModal.addEventListener('click', e => e.target === importConfirmModal && closeImportConfirmModal());
        deleteConfirmModal.addEventListener('click', e => e.target === deleteConfirmModal && closeDeleteConfirm());
        resetConfirmModal.addEventListener('click', e => e.target === resetConfirmModal && closeResetConfirm());
        editStationForm.addEventListener('submit', saveStationChanges);
        deleteStationBtn.addEventListener('click', () => openDeleteConfirm(stations[currentEditingIndex], currentEditingIndex));
        settingsBtn.addEventListener('click', openSettingsModal);
        themeToggleBtn.addEventListener('click', toggleThemeAndClose);
        langToggleBtn.addEventListener('click', toggleLanguageAndClose);
        addStationBtn.addEventListener('click', () => { closeSettingsModal(); openAddModal(); });
        addStationForm.addEventListener('submit', saveNewStation);
        openImportOptionsBtn.addEventListener('click', openImportOptionsModal);
        openExportOptionsBtn.addEventListener('click', openExportOptionsModal);
        closeImportOptionsBtn.addEventListener('click', closeImportOptionsModal);
        closeExportOptionsBtn.addEventListener('click', closeExportOptionsModal);
        importStationsChoiceBtn.addEventListener('click', () => { fileInput.dataset.importType = 'stations'; fileInput.click(); closeImportOptionsModal(); });
        importProfileChoiceBtn.addEventListener('click', () => { fileInput.dataset.importType = 'profile'; fileInput.click(); closeImportOptionsModal(); });
        importFromUrlChoiceBtn.addEventListener('click', openImportUrlModal);
        closeImportUrlModalBtn.addEventListener('click', closeImportUrlModal);
        importUrlForm.addEventListener('submit', handleUrlImport);
        exportStationsChoiceBtn.addEventListener('click', () => { exportContentTypeSelection.classList.add('hidden'); exportFormatSelection.classList.remove('hidden'); });
        exportProfileChoiceBtn.addEventListener('click', handleExportProfile);
        exportToJsonBtn.addEventListener('click', handleExportStationsAsJson);
        exportToM3uBtn.addEventListener('click', () => exportToPlaylist('m3u'));
        exportToM3u8Btn.addEventListener('click', () => exportToPlaylist('m3u8'));
        fileInput.addEventListener('change', handleFileImport);
        resetBtn.addEventListener('click', openResetConfirm);
        mergeBtn.addEventListener('click', mergeLists); 
        replaceBtn.addEventListener('click', replaceList);
        confirmDeleteBtn.addEventListener('click', deleteStation);
        confirmResetBtn.addEventListener('click', resetList);
        closeMediaTypeSelectBtn.addEventListener('click', () => mediaTypeSelectModal.classList.add('hidden'));
        setMediaTypeAudioBtn.addEventListener('click', () => setImportedMediaType('audio'));
        setMediaTypeVideoBtn.addEventListener('click', () => setImportedMediaType('video'));
        new Sortable(stationListUL, { animation: 150, ghostClass: 'sortable-ghost', delay: 250, delayOnTouchOnly: true, filter: '.edit-btn', onEnd: function (evt) { const movedItem = stations.splice(evt.oldIndex, 1)[0]; stations.splice(evt.newIndex, 0, movedItem); saveStations(); }, });
        const savedLang = localStorage.getItem('language') || 'en';
        setLanguage(savedLang);
        applyFontSizes();
        applyStationLogoSize();
        setupDraggablePopup();
    };
    initialize();
  </script>
  <script>
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').then(registration => { console.log('SW registration successful:', registration.scope); }).catch(err => { console.log('SW registration failed:', err); }); }); }
  </script>
</body>
</html>